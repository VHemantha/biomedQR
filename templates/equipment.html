{% extends "base.html" %}

{% block title %}Equipment {{ equipment_id }} - Actions{% endblock %}

{% block content %}
<button class="back-btn" onclick="goBackToGenerator()">‚Üê Back to Generator</button>

<div class="equipment-info">
    üè≠ Item: <span style="color: #667eea;">{{ equipment_id }}</span>
</div>

<div class="welcome-section">
    <h2 class="welcome-title">Welcome to Equipment Portal</h2>
    <p class="welcome-subtitle">Scan QR/Barcode to auto-load data or click button below:</p>
</div>

<!-- Scanning Status Indicator -->
<div id="scanningIndicator" class="scanning-indicator" style="display: none; text-align: center; margin: 20px 0; padding: 15px; background-color: #e6fffa; border-left: 4px solid #38b6a8; border-radius: 4px;">
    <div class="spinner" style="display: inline-block; margin-right: 10px;"></div>
    <span id="scanningText" style="color: #38b6a8; font-weight: 500;">üì± Scanning detected... Auto-fetching data</span>
</div>

<!-- Get Master Data Button -->
<div id="getMasterDataSection" style="text-align: center; margin: 30px 0;">
    <button class="master-data-btn" onclick="fetchAndMapMasterData()" id="getMasterDataBtn">
        <div class="action-icon">üîç</div>
        <div>Get Master Data</div>
    </button>
    <p style="color: #718096; margin-top: 10px; font-size: 14px;">
        üì± Tip: Scan a barcode/QR code to auto-load data
    </p>
</div>

<!-- Master Data Form Section (Initially Hidden) -->
<div id="masterDataForm" class="master-data-form" style="display: none;">
    <h3 style="color: #667eea; margin-bottom: 20px;">üìã Equipment Details</h3>
    
    <div class="form-group">
        <label for="form-itemID">Item ID:</label>
        <input type="text" id="form-itemID" readonly style="background-color: #f5f5f5;">
    </div>
    
    <div class="form-group">
        <label for="form-area">Area:</label>
        <input type="text" id="form-area" readonly style="background-color: #f5f5f5;">
    </div>
    
    <div class="form-group">
        <label for="form-location">Location:</label>
        <input type="text" id="form-location" readonly style="background-color: #f5f5f5;">
    </div>
    
    <div class="form-group">
        <label for="form-productLocation">Hospital / Product Location:</label>
        <input type="text" id="form-productLocation" readonly style="background-color: #f5f5f5;">
    </div>
    
    <div class="form-group">
        <label for="form-productModel">Product Model / Modality:</label>
        <input type="text" id="form-productModel" readonly style="background-color: #f5f5f5;">
    </div>
    
    <div class="form-group">
        <label for="form-serialNumber">Serial Number:</label>
        <input type="text" id="form-serialNumber" readonly style="background-color: #f5f5f5;">
    </div>
    
    <div class="form-group">
        <label for="form-supplierName">Supplier Name:</label>
        <input type="text" id="form-supplierName" readonly style="background-color: #f5f5f5;">
    </div>
    
    <div class="form-group">
        <label for="form-unit">Unit:</label>
        <input type="text" id="form-unit" readonly style="background-color: #f5f5f5;">
    </div>
    
    <div class="form-group">
        <label for="form-createdDate">Created Date:</label>
        <input type="text" id="form-createdDate" readonly style="background-color: #f5f5f5;">
    </div>
    
    <div class="form-group">
        <label for="form-lastUpdatedDate">Last Updated Date:</label>
        <input type="text" id="form-lastUpdatedDate" readonly style="background-color: #f5f5f5;">
    </div>
    
    <!-- Contact Number - Editable Field -->
    <div class="form-group">
        <label for="form-contactNumber">Contact Number: <span style="color: #fc466b;">*</span></label>
        <input type="tel" id="form-contactNumber" placeholder="Enter contact number" required style="background-color: #ffffff; border: 2px solid #667eea;">
        <small style="color: #718096; font-size: 12px;">Required field - Please enter your contact number</small>
    </div>
</div>

<!-- Action Options (Initially Disabled) -->
<div class="action-options" id="actionOptions" style="opacity: 0.5; pointer-events: none;">
    <button class="action-btn repair" onclick="selectAction('repair')" id="repairBtn" disabled>
        <div class="action-icon">üîß</div>
        <div>Repair</div>
    </button>
    
    <button class="action-btn training" onclick="selectAction('user_training')" id="trainingBtn" disabled>
        <div class="action-icon">üìö</div>
        <div>User Training</div>
    </button>
    
    <button class="action-btn maintenance" onclick="selectAction('one_time_service')" id="maintenanceBtn" disabled>
        <div class="action-icon">‚öôÔ∏è</div>
        <div>One time service request</div>
    </button>
    
    <button class="action-btn status" onclick="selectAction('consumer_request')" id="statusBtn" disabled>
        <div class="action-icon">üìä</div>
        <div>Consumer request</div>
    </button>
</div>

<div id="statusMessage"></div>
{% endblock %}

{% block extra_scripts %}
<script>
// Application state
const currentEquipmentId = '{{ equipment_id }}';
let hospital = `{{ hospital }}`;
let unitCode = `{{ unit_code }}`;
let serialNumber = `{{ serial_number }}`;
let supplierName = `{{ supplier_name }}`;
let unit = `{{ unit }}`;
let itemId = `{{ item_id }}`;
let area = '';
let location = '';
let masterDataLoaded = false;
let contactNumber = '';
let autoScannedData = false;

// Barcode/QR Scanner Detection Variables
let scanBuffer = '';
let scanTimeout = null;
let isScanning = false;
const SCAN_TIMEOUT_MS = 100; // Time window for scan completion
const MIN_SCAN_LENGTH = 3;
const MAX_SCAN_LENGTH = 50;

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    console.log('üöÄ Equipment Portal initialized');
    console.log('Item ID from URL:', itemId);
    
    // Initialize barcode scanner detection
    initializeBarcodeScanner();
    
    // Auto-fetch if itemId exists in URL
    if (itemId && itemId.trim() !== '' && itemId !== 'None') {
        console.log('‚úÖ Item ID found, auto-fetching data...');
        setTimeout(() => {
            fetchAndMapMasterData();
        }, 500);
    }
});

// Initialize Barcode/QR Scanner Detection
function initializeBarcodeScanner() {
    console.log('üîç Barcode scanner detection initialized');
    
    document.addEventListener('keydown', function(event) {
        // Ignore keyboard input if user is typing in an input field
        if (event.target.tagName === 'INPUT' || event.target.tagName === 'TEXTAREA') {
            return;
        }
        
        // Start scanning detection
        if (!isScanning) {
            isScanning = true;
            scanBuffer = '';
            showScanningIndicator(true);
            console.log('üì± Scan started...');
        }
        
        // Clear previous timeout
        if (scanTimeout) {
            clearTimeout(scanTimeout);
        }
        
        // Accumulate characters (only single printable characters)
        if (event.key.length === 1) {
            scanBuffer += event.key;
            
            // Prevent buffer overflow
            if (scanBuffer.length > MAX_SCAN_LENGTH) {
                console.log('‚ö†Ô∏è Scan buffer overflow, resetting...');
                resetScanner();
                return;
            }
        }
        
        // Enter key typically signals end of barcode scan
        if (event.key === 'Enter' && scanBuffer.length >= MIN_SCAN_LENGTH) {
            event.preventDefault();
            console.log('‚úÖ Scan completed (Enter key):', scanBuffer);
            handleScanComplete(scanBuffer.trim());
            resetScanner();
            return;
        }
        
        // Set timeout for auto-completion (if no Enter key)
        scanTimeout = setTimeout(() => {
            if (scanBuffer.length >= MIN_SCAN_LENGTH) {
                console.log('‚úÖ Scan completed (timeout):', scanBuffer);
                handleScanComplete(scanBuffer.trim());
            }
            resetScanner();
        }, SCAN_TIMEOUT_MS);
    });
}

// Reset scanner state
function resetScanner() {
    scanBuffer = '';
    isScanning = false;
    showScanningIndicator(false);
    if (scanTimeout) {
        clearTimeout(scanTimeout);
        scanTimeout = null;
    }
}

// Show/Hide scanning indicator
function showScanningIndicator(show) {
    const indicator = document.getElementById('scanningIndicator');
    if (show) {
        indicator.style.display = 'block';
    } else {
        setTimeout(() => {
            indicator.style.display = 'none';
        }, 800);
    }
}

// Handle completed scan - AUTOMATICALLY TRIGGER DATA FETCH
function handleScanComplete(scannedData) {
    console.log('üîç Processing scanned data:', scannedData);
    
    // Try to extract Item ID from scanned data
    // Common formats: "EQ12345", "ITEM-001", or just numbers "123456"
    const itemIdMatch = scannedData.match(/([A-Z]{2,}\d+|[A-Z]+-\d+|\d{4,})/i);
    
    if (itemIdMatch || scannedData.length >= MIN_SCAN_LENGTH) {
        autoScannedData = true;
        
        // Update itemId
        if (itemIdMatch) {
            itemId = itemIdMatch[0].toUpperCase();
            console.log('üìå Extracted Item ID:', itemId);
        } else {
            itemId = scannedData;
            console.log('üìå Using full scan as Item ID:', itemId);
        }
        
        // Update equipment info display
        const equipmentInfoSpan = document.querySelector('.equipment-info span');
        if (equipmentInfoSpan) {
            equipmentInfoSpan.textContent = itemId;
        }
        
        // Automatically trigger data fetch
        console.log('üöÄ Auto-triggering data fetch...');
        showStatus('üì± Scan detected! Fetching data for Item ID: ' + itemId, 'loading');
        
        setTimeout(() => {
            fetchAndMapMasterData();
        }, 300);
        
    } else {
        console.log('‚ùå Invalid scan - too short or invalid format');
        showStatus('‚ö†Ô∏è Invalid scan. Please try again or enter Item ID manually.', 'error');
    }
}

// Fetch and map master data from API
function fetchAndMapMasterData() {
    const btn = document.getElementById('getMasterDataBtn');
    const formSection = document.getElementById('masterDataForm');
    const actionOptions = document.getElementById('actionOptions');
    const getMasterDataSection = document.getElementById('getMasterDataSection');

    // Validate itemId
    if (!itemId || itemId.trim() === '' || itemId === 'None') {
        showStatus('‚ùå Item ID is missing. Please scan a QR code or enter Item ID.', 'error');
        return;
    }

    console.log('üì° Fetching data for Item ID:', itemId);

    // Disable button while loading
    btn.disabled = true;
    btn.innerHTML = '<div class="spinner"></div><div>Loading...</div>';

    const source = autoScannedData ? 'üîç Auto-scan' : 'üëÜ Manual';
    showStatus(`${source} - Fetching master data for Item ID: ${itemId}...`, 'loading');

    // Fetch master data from backend API
    fetch(`/api/get_master_data/${encodeURIComponent(itemId)}`)
        .then(response => {
            console.log('üì• API Response Status:', response.status);
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            return response.json();
        })
        .then(data => {
            console.log('üì¶ API Response Data:', data);
            
            if (data.success && data.data) {
                const apiData = data.data;
                
                // ========================================
                // FIELD MAPPING: API Response -> HTML Form
                // ========================================
                
                // Core Fields
                document.getElementById('form-itemID').value = apiData.itemID || 'N/A';
                document.getElementById('form-area').value = apiData.area || 'N/A';
                document.getElementById('form-location').value = apiData.location || 'N/A';
                document.getElementById('form-productLocation').value = apiData.productLocation || 'N/A';
                document.getElementById('form-productModel').value = apiData.productModel || 'N/A';
                document.getElementById('form-serialNumber').value = apiData.serialNumber || 'N/A';
                document.getElementById('form-supplierName').value = apiData.supplierName || 'N/A';
                document.getElementById('form-unit').value = apiData.unit || 'N/A';
                
                // Date Fields
                document.getElementById('form-createdDate').value = apiData.createdDate || 'N/A';
                document.getElementById('form-lastUpdatedDate').value = apiData.lastUpdatedDate || 'N/A';
                
                // Pre-fill contact number if available
                if (apiData.contactNumber) {
                    document.getElementById('form-contactNumber').value = apiData.contactNumber;
                }

                // Update local state variables
                area = apiData.area || '';
                location = apiData.location || '';
                hospital = apiData.productLocation || hospital;
                unitCode = apiData.productModel || unitCode;
                serialNumber = apiData.serialNumber || serialNumber;
                supplierName = apiData.supplierName || supplierName;
                unit = apiData.unit || unit;

                console.log('‚úÖ Data mapped successfully');
                console.log('State:', { area, location, hospital, unitCode, serialNumber, supplierName, unit });

                // Show the form section with smooth scroll
                formSection.style.display = 'block';
                formSection.scrollIntoView({ behavior: 'smooth', block: 'nearest' });

                // Hide the "Get Master Data" section (optional)
                // getMasterDataSection.style.display = 'none';

                // Enable action buttons
                enableActionButtons();
                masterDataLoaded = true;

                // Update button to show success
                btn.innerHTML = '<div class="action-icon">‚úÖ</div><div>Data Loaded Successfully</div>';
                btn.style.backgroundColor = '#48bb78';
                btn.style.cursor = 'default';

                const successMessage = autoScannedData 
                    ? '‚úÖ Master data auto-loaded from scan! Please enter contact number and select an action.'
                    : '‚úÖ Master data loaded successfully! Please enter contact number and select an action.';
                
                showStatus(successMessage, 'success');
                
                // Focus on contact number field
                setTimeout(() => {
                    document.getElementById('form-contactNumber').focus();
                }, 500);

            } else {
                const errorMsg = data.error || 'Unknown error occurred';
                console.error('‚ùå API Error:', errorMsg);
                showStatus(`‚ùå Error: ${errorMsg}`, 'error');
                
                // Re-enable button
                btn.disabled = false;
                btn.innerHTML = '<div class="action-icon">üîç</div><div>Get Master Data</div>';
            }
        })
        .catch(error => {
            console.error('‚ùå Fetch error:', error);
            showStatus(`‚ùå Failed to fetch master data: ${error.message}`, 'error');
            
            // Re-enable button
            btn.disabled = false;
            btn.innerHTML = '<div class="action-icon">üîç</div><div>Get Master Data</div>';
        });
}

function enableActionButtons() {
    const actionOptions = document.getElementById('actionOptions');
    const actionBtns = document.querySelectorAll('.action-btn');
    
    // Enable the action section
    actionOptions.style.opacity = '1';
    actionOptions.style.pointerEvents = 'auto';
    
    // Enable all action buttons
    actionBtns.forEach(btn => {
        btn.disabled = false;
        btn.style.cursor = 'pointer';
    });
    
    console.log('‚úÖ Action buttons enabled');
}

function selectAction(action) {
    if (!masterDataLoaded) {
        showStatus('‚ö†Ô∏è Please load master data first by clicking "Get Master Data" button', 'error');
        return;
    }

    // Get contact number from the input field
    contactNumber = document.getElementById('form-contactNumber').value.trim();
    
    // Validate contact number
    if (!contactNumber) {
        showStatus('‚ö†Ô∏è Please enter a contact number before submitting a request', 'error');
        document.getElementById('form-contactNumber').focus();
        document.getElementById('form-contactNumber').style.borderColor = '#fc466b';
        return;
    }

    // Validate contact number format (basic validation)
    const contactRegex = /^[\d\s\+\-\(\)]{7,15}$/;
    if (!contactRegex.test(contactNumber)) {
        showStatus('‚ö†Ô∏è Please enter a valid contact number (7-15 digits)', 'error');
        document.getElementById('form-contactNumber').focus();
        document.getElementById('form-contactNumber').style.borderColor = '#fc466b';
        return;
    }

    // Reset border color
    document.getElementById('form-contactNumber').style.borderColor = '#667eea';

    const actionNames = {
        'repair': 'Repair',
        'user_training': 'User Training',
        'one_time_service': 'One Time Service',
        'consumer_request': 'Consumer Request'
    };
    
    const selectedAction = actionNames[action];
    
    console.log('üîß Action selected:', selectedAction);
    
    // Disable all action buttons while processing
    disableActionButtons(true);
    
    showStatus(`‚è≥ ${selectedAction} selected for equipment ${itemId}. Processing...`, 'loading');
    
    // Prepare request payload
    const requestPayload = {
        action: action,
        equipment_id: currentEquipmentId,
        area: area,
        location: location,
        hospital: hospital,
        unit_code: unitCode,
        serial_number: serialNumber,
        supplier_name: supplierName,
        unit: unit,
        item_id: itemId,
        contact_number: contactNumber
    };
    
    console.log('üì§ Sending request:', requestPayload);
    
    // Make API request to Flask backend
    fetch('/api/action', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(requestPayload)
    })
    .then(response => {
        console.log('üì• Action Response Status:', response.status);
        return response.json();
    })
    .then(data => {
        console.log('üì¶ Action Response:', data);
        
        if (data.success) {
            showStatus(`‚úÖ ${data.message}`, 'success');
            // Disable the specific button that was clicked
            disableSpecificButton(action);
        } else {
            showStatus(`‚ùå Failed: ${data.error}`, 'error');
        }
    })
    .catch(error => {
        console.error('‚ùå Action error:', error);
        showStatus(`‚ùå Failed to submit ${selectedAction.toLowerCase()} request: ${error.message}`, 'error');
    })
    .finally(() => {
        disableActionButtons(false);
    });
}

function disableSpecificButton(action) {
    // Map action to button ID
    const actionToButtonId = {
        'repair': 'repairBtn',
        'user_training': 'trainingBtn',
        'one_time_service': 'maintenanceBtn',
        'consumer_request': 'statusBtn'
    };
    
    const buttonId = actionToButtonId[action];
    if (buttonId) {
        const button = document.getElementById(buttonId);
        if (button) {
            button.disabled = true;
            button.style.opacity = '0.6';
            button.style.cursor = 'not-allowed';
            button.innerHTML = `
                <div class="action-icon">‚úÖ</div>
                <div>Completed</div>
            `;
            console.log('‚úÖ Button marked as completed:', buttonId);
        }
    }
}

function disableActionButtons(disable) {
    const actionBtns = document.querySelectorAll('.action-btn');
    actionBtns.forEach(btn => {
        if (!btn.innerHTML.includes('‚úÖ')) { // Don't re-enable completed buttons
            btn.disabled = disable;
            if (disable) {
                btn.style.cursor = 'not-allowed';
                btn.style.opacity = '0.6';
            } else {
                btn.style.cursor = 'pointer';
                btn.style.opacity = '1';
            }
        }
    });
}

function goBackToGenerator() {
    window.location.href = '/';
}

function showStatus(message, type) {
    const statusDiv = document.getElementById('statusMessage');
    let iconClass = '';

    if (type === 'loading') {
        iconClass = '<div class="spinner"></div>';
    }

    statusDiv.innerHTML = `<div class="status-message status-${type}">${iconClass}${message}</div>`;

    if (type === 'success') {
        setTimeout(() => {
            statusDiv.innerHTML = '';
        }, 5000);
    } else if (type === 'error') {
        setTimeout(() => {
            statusDiv.innerHTML = '';
        }, 10000);
    }
}
</script>
{% endblock %}