{% extends "base.html" %}

{% block title %}Equipment {{ equipment_id }} - Actions{% endblock %}

{% block content %}
<button class="back-btn" onclick="goBackToGenerator()">‚Üê Back to Generator</button>

<div class="equipment-info">
    üè≠ Item: <span style="color: #667eea;">{{ equipment_id }}</span>
</div>

<div class="welcome-section">
    <h2 class="welcome-title">Welcome to Equipment Portal</h2>
    <p class="welcome-subtitle">Scan QR/Barcode or click button to load data:</p>
</div>

<!-- Manual Fetch Button (Optional - for manual trigger) -->
<div style="text-align: center; margin: 20px 0;">
    <button class="master-data-btn" id="getMasterDataBtn" onclick="fetchAndMapMasterData()">
        <span>üìã</span>
        <span>Get Master Data</span>
    </button>
</div>

<!-- Scanning Status Indicator -->
<div id="scanningIndicator" class="scanning-indicator" style="display: none; text-align: center; margin: 20px 0; padding: 15px; background-color: #e6fffa; border-left: 4px solid #38b6a8; border-radius: 4px;">
    <div class="spinner" style="display: inline-block; margin-right: 10px;"></div>
    <span id="scanningText" style="color: #38b6a8; font-weight: 500;">Scanning QR/Barcode... Auto-fetching data</span>
</div>

<!-- Waiting for Scan Message -->
<div id="waitingForScan" style="text-align: center; margin: 30px 0; padding: 20px; background-color: #f0f4ff; border-radius: 8px; border: 2px dashed #667eea;">
    <div style="font-size: 18px; color: #667eea; font-weight: 500;">üì± Ready for Scan</div>
    <p style="color: #718096; margin-top: 10px;">Please scan the QR code or barcode to auto-load equipment data</p>
</div>

<!-- Master Data Form Section (Initially Hidden) -->
<div id="masterDataForm" class="master-data-form" style="display: none;">
    <h3 style="color: #667eea; margin-bottom: 20px;">Equipment Details</h3>
    
    <div class="form-group">
        <label for="form-itemID">Item ID:</label>
        <input type="text" id="form-itemID" readonly style="background-color: #f5f5f5;">
    </div>
    
    <div class="form-group">
        <label for="form-area">Area:</label>
        <input type="text" id="form-area" readonly style="background-color: #f5f5f5;">
    </div>
    
    <div class="form-group">
        <label for="form-productLocation">Hospital / Location:</label>
        <input type="text" id="form-productLocation" readonly style="background-color: #f5f5f5;">
    </div>
    
    <div class="form-group">
        <label for="form-productModel">Modality (Product Model):</label>
        <input type="text" id="form-productModel" readonly style="background-color: #f5f5f5;">
    </div>
    
    <div class="form-group">
        <label for="form-serialNumber">Serial Number:</label>
        <input type="text" id="form-serialNumber" readonly style="background-color: #f5f5f5;">
    </div>
    
    <div class="form-group">
        <label for="form-supplierName">Supplier Name:</label>
        <input type="text" id="form-supplierName" readonly style="background-color: #f5f5f5;">
    </div>
    
    <div class="form-group">
        <label for="form-unit">Location (Unit):</label>
        <input type="text" id="form-unit" readonly style="background-color: #f5f5f5;">
    </div>
    
    <div class="form-group">
        <label for="form-createdDate">Created Date:</label>
        <input type="text" id="form-createdDate" readonly style="background-color: #f5f5f5;">
    </div>
    
    <div class="form-group">
        <label for="form-lastUpdatedDate">Last Updated Date:</label>
        <input type="text" id="form-lastUpdatedDate" readonly style="background-color: #f5f5f5;">
    </div>
    
    <!-- Contact Number - Editable Field -->
    <div class="form-group">
        <label for="form-contactNumber">Contact Number: <span style="color: #fc466b;">*</span></label>
        <input type="tel" id="form-contactNumber" placeholder="Enter contact number" required style="background-color: #ffffff; border: 2px solid #667eea;">
        <small style="color: #718096; font-size: 12px;">Required field - Please enter your contact number</small>
    </div>
</div>

<!-- Action Options (Initially Disabled) -->
<div class="action-options" id="actionOptions" style="opacity: 0.5; pointer-events: none;">
    <button class="action-btn repair" onclick="selectAction('repair')" id="repairBtn" disabled>
        <div class="action-icon">üîß</div>
        <div>Repair</div>
    </button>
    
    <button class="action-btn training" onclick="selectAction('user_training')" id="trainingBtn" disabled>
        <div class="action-icon">üìö</div>
        <div>User Training</div>
    </button>
    
    <button class="action-btn maintenance" onclick="selectAction('one_time_service')" id="maintenanceBtn" disabled>
        <div class="action-icon">‚öôÔ∏è</div>
        <div>One time service request</div>
    </button>
    
    <button class="action-btn status" onclick="selectAction('consumer_request')" id="statusBtn" disabled>
        <div class="action-icon">üìä</div>
        <div>Consumer request</div>
    </button>
</div>

<div id="statusMessage"></div>
{% endblock %}

{% block extra_scripts %}
<script>
// Application state
const currentEquipmentId = '{{ equipment_id }}';
let hospital = `{{ hospital }}`;
let unitCode = `{{ unit_code }}`;
let serialNumber = `{{ serial_number }}`;
let supplierName = `{{ supplier_name }}`;
let unit = `{{ unit }}`;
let itemId = `{{ item_id }}`;
let area = '';
let masterDataLoaded = false;
let contactNumber = '';
let autoScannedData = false;
let scanBuffer = '';
let scanTimeout = null;
const SCAN_TIMEOUT = 100; // milliseconds to wait for scan completion
const MIN_SCAN_LENGTH = 4;
const MAX_SCAN_LENGTH = 50;

// Initialize auto-scan detection on page load
document.addEventListener('DOMContentLoaded', function() {
    console.log('Page loaded - Initializing scan detection');
    initializeScanDetection();
    
    // Optional: Auto-fetch data if itemId is already available (from URL params)
    if (itemId && itemId.trim() !== '') {
        console.log('Item ID found in URL, auto-fetching data...');
        setTimeout(() => {
            fetchAndMapMasterData();
        }, 500);
    }
});

// Initialize barcode/QR scan detection
function initializeScanDetection() {
    let localScanBuffer = '';
    let localIsScanning = false;
    let localScanTimeout = null;

    console.log('Scan detection initialized');

    // Listen for keyboard input (barcode scanners emit keyboard events)
    document.addEventListener('keydown', function(event) {
        // Ignore if user is typing in an input/textarea field
        if (event.target.tagName === 'INPUT' || event.target.tagName === 'TEXTAREA') {
            return;
        }

        // Start scan detection
        if (!localIsScanning) {
            localIsScanning = true;
            localScanBuffer = '';
            showScanningIndicator(true);
            console.log('Scan started');
        }

        // Clear existing timeout
        if (localScanTimeout) {
            clearTimeout(localScanTimeout);
        }

        // Accumulate characters (only single characters, ignore special keys)
        if (event.key.length === 1) {
            localScanBuffer += event.key;
            console.log('Scan buffer:', localScanBuffer);
            
            // Prevent buffer overflow
            if (localScanBuffer.length > MAX_SCAN_LENGTH) {
                console.log('Buffer overflow, resetting');
                resetScan();
                return;
            }
        }

        // Detect scan completion (Enter key marks end of scan)
        if (event.key === 'Enter' && localScanBuffer.length >= MIN_SCAN_LENGTH) {
            event.preventDefault();
            console.log('Scan completed with Enter key:', localScanBuffer);
            handleScanComplete(localScanBuffer.trim());
            resetScan();
            return;
        }

        // Set timeout to detect scan end if no Enter key
        localScanTimeout = setTimeout(() => {
            if (localScanBuffer.length >= MIN_SCAN_LENGTH) {
                console.log('Scan completed by timeout:', localScanBuffer);
                handleScanComplete(localScanBuffer.trim());
            }
            resetScan();
        }, SCAN_TIMEOUT);
    });
    
    function resetScan() {
        localScanBuffer = '';
        localIsScanning = false;
        showScanningIndicator(false);
        if (localScanTimeout) {
            clearTimeout(localScanTimeout);
            localScanTimeout = null;
        }
        console.log('Scan reset');
    }
}

// Show/hide scanning indicator
function showScanningIndicator(show) {
    const indicator = document.getElementById('scanningIndicator');
    const waitingMessage = document.getElementById('waitingForScan');
    
    if (show) {
        indicator.style.display = 'block';
        if (waitingMessage) waitingMessage.style.display = 'none';
    } else {
        setTimeout(() => {
            indicator.style.display = 'none';
            if (waitingMessage && !masterDataLoaded) {
                waitingMessage.style.display = 'block';
            }
        }, 500);
    }
}

// Handle scan completion - AUTOMATICALLY FETCH DATA
function handleScanComplete(scannedData) {
    console.log('Processing scanned data:', scannedData);
    
    // Parse scanned data - could be Item ID or Serial Code
    // Try to extract equipment ID format (e.g., "EQ12345" or just numbers)
    const equipmentIdMatch = scannedData.match(/([A-Z]{2,}\d+|\d{4,})/i);
    
    if (equipmentIdMatch || scannedData.length >= MIN_SCAN_LENGTH) {
        autoScannedData = true;
        
        // Update itemId if we found a valid ID
        if (equipmentIdMatch) {
            itemId = equipmentIdMatch[0];
            console.log('Extracted Item ID:', itemId);
        } else {
            itemId = scannedData; // Use the whole scanned string
            console.log('Using full scan as Item ID:', itemId);
        }
        
        // Hide waiting message
        const waitingMessage = document.getElementById('waitingForScan');
        if (waitingMessage) {
            waitingMessage.style.display = 'none';
        }
        
        // Automatically fetch master data
        console.log('Triggering automatic data fetch...');
        fetchAndMapMasterData();
    } else {
        console.log('Scanned data too short or invalid format');
        showStatus('Invalid scan - please try again', 'error');
    }
}

// Fetch master data from API and map to form fields
function fetchAndMapMasterData() {
    const btn = document.getElementById('getMasterDataBtn');
    const formSection = document.getElementById('masterDataForm');
    const actionOptions = document.getElementById('actionOptions');
    const waitingMessage = document.getElementById('waitingForScan');

    // Validate itemId
    if (!itemId || itemId.trim() === '') {
        showStatus('Item ID is missing. Please scan the QR code or enter manually.', 'error');
        return;
    }

    // Disable button while loading
    if (btn) {
        btn.disabled = true;
        btn.innerHTML = '<div class="spinner"></div><div>Loading...</div>';
    }

    const source = autoScannedData ? 'auto-scan' : 'manual';
    showStatus(`Fetching master data for Item ID: ${itemId} (${source})...`, 'loading');
    console.log(`Fetching data for Item ID: ${itemId}`);

    // Hide waiting message
    if (waitingMessage) {
        waitingMessage.style.display = 'none';
    }

    // Fetch master data from backend
    fetch(`/api/get_master_data/${encodeURIComponent(itemId)}`)
        .then(response => {
            console.log('API Response Status:', response.status);
            return response.json();
        })
        .then(data => {
            console.log('API Response Data:', data);
            
            if (data.success) {
                // Map API response to form fields with proper field mapping
                const apiData = data.data;
                
                // Field Mapping: API Key -> HTML Field ID
                document.getElementById('form-itemID').value = apiData.itemID || 'N/A';
                document.getElementById('form-area').value = apiData.area || 'N/A';
                document.getElementById('form-productLocation').value = apiData.productLocation || 'N/A'; // Hospital
                document.getElementById('form-productModel').value = apiData.productModel || 'N/A'; // Modality
                document.getElementById('form-serialNumber').value = apiData.serialNumber || 'N/A';
                document.getElementById('form-supplierName').value = apiData.supplierName || 'N/A';
                document.getElementById('form-unit').value = apiData.unit || 'N/A'; // Location
                document.getElementById('form-createdDate').value = apiData.createdDate || 'N/A';
                document.getElementById('form-lastUpdatedDate').value = apiData.lastUpdatedDate || 'N/A';
                
                // Pre-fill contact number if available from API
                if (apiData.contactNumber) {
                    document.getElementById('form-contactNumber').value = apiData.contactNumber;
                }

                // Update local variables with fetched data
                area = apiData.area || '';
                hospital = apiData.productLocation || hospital;
                unitCode = apiData.productModel || unitCode;
                serialNumber = apiData.serialNumber || serialNumber;
                supplierName = apiData.supplierName || supplierName;
                unit = apiData.unit || unit;

                // Show the form section with animation
                formSection.style.display = 'block';
                formSection.scrollIntoView({ behavior: 'smooth', block: 'nearest' });

                // Enable action buttons
                enableActionButtons();
                masterDataLoaded = true;

                const message = autoScannedData 
                    ? '‚úÖ Master data auto-loaded from scan! Please enter contact number and select an action.'
                    : '‚úÖ Master data loaded successfully! Please enter contact number and select an action.';
                showStatus(message, 'success');
                
                // Reset button
                if (btn) {
                    btn.disabled = false;
                    btn.innerHTML = '<span>üìã</span><span>Get Master Data</span>';
                }
                
                console.log('Data mapping completed successfully');
            } else {
                showStatus(`‚ùå Error: ${data.error}`, 'error');
                console.error('API Error:', data.error);
                
                // Re-enable button
                if (btn) {
                    btn.disabled = false;
                    btn.innerHTML = '<span>üìã</span><span>Get Master Data</span>';
                }
                
                // Show waiting message again
                if (waitingMessage) {
                    waitingMessage.style.display = 'block';
                }
            }
        })
        .catch(error => {
            console.error('Fetch error:', error);
            showStatus(`‚ùå Failed to fetch master data: ${error.message}`, 'error');
            
            // Re-enable button
            if (btn) {
                btn.disabled = false;
                btn.innerHTML = '<span>üìã</span><span>Get Master Data</span>';
            }
            
            // Show waiting message again
            if (waitingMessage) {
                waitingMessage.style.display = 'block';
            }
        });
}

function enableActionButtons() {
    const actionOptions = document.getElementById('actionOptions');
    const actionBtns = document.querySelectorAll('.action-btn');
    
    // Enable the action section
    actionOptions.style.opacity = '1';
    actionOptions.style.pointerEvents = 'auto';
    
    // Enable all action buttons
    actionBtns.forEach(btn => {
        btn.disabled = false;
        btn.style.cursor = 'pointer';
    });
    
    console.log('Action buttons enabled');
}

function selectAction(action) {
    if (!masterDataLoaded) {
        showStatus('‚ö†Ô∏è Please load master data first', 'error');
        return;
    }

    // Get contact number from the input field
    contactNumber = document.getElementById('form-contactNumber').value.trim();
    
    // Validate contact number
    if (!contactNumber) {
        showStatus('‚ö†Ô∏è Please enter a contact number before submitting a request', 'error');
        document.getElementById('form-contactNumber').focus();
        document.getElementById('form-contactNumber').style.borderColor = '#fc466b';
        return;
    }

    // Reset border color
    document.getElementById('form-contactNumber').style.borderColor = '#667eea';

    const actionNames = {
        'repair': 'Repair',
        'user_training': 'User Training',
        'one_time_service': 'One Time Service',
        'consumer_request': 'Consumer Request'
    };
    
    const selectedAction = actionNames[action];
    
    // Disable all action buttons while processing
    disableActionButtons(true);
    
    showStatus(`${selectedAction} selected for equipment ${itemId}. Processing...`, 'loading');
    console.log('Submitting action:', action);
    
    // Make API request to Flask backend
    fetch('/api/action', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            action: action,
            equipment_id: currentEquipmentId,
            area: area,
            hospital: hospital,
            unit_code: unitCode,
            serial_number: serialNumber,
            supplier_name: supplierName,
            unit: unit,
            item_id: itemId,
            contact_number: contactNumber
        })
    })
    .then(response => response.json())
    .then(data => {
        console.log('Action response:', data);
        if (data.success) {
            showStatus(`‚úÖ ${data.message}`, 'success');
            // Disable the specific button that was clicked
            disableSpecificButton(action);
        } else {
            showStatus(`‚ùå Failed: ${data.error}`, 'error');
        }
    })
    .catch(error => {
        console.error('Action error:', error);
        showStatus(`‚ùå Failed to submit ${selectedAction.toLowerCase()} request: ${error.message}`, 'error');
    })
    .finally(() => {
        disableActionButtons(false);
    });
}

function disableSpecificButton(action) {
    const actionToButtonId = {
        'repair': 'repairBtn',
        'user_training': 'trainingBtn',
        'one_time_service': 'maintenanceBtn',
        'consumer_request': 'statusBtn'
    };
    
    const buttonId = actionToButtonId[action];
    if (buttonId) {
        const button = document.getElementById(buttonId);
        if (button) {
            button.disabled = true;
            button.style.opacity = '0.6';
            button.style.cursor = 'not-allowed';
            button.innerHTML = `
                <div class="action-icon">‚úÖ</div>
                <div>Completed</div>
            `;
        }
    }
}

function disableActionButtons(disable) {
    const actionBtns = document.querySelectorAll('.action-btn');
    actionBtns.forEach(btn => {
        if (!btn.innerHTML.includes('‚úÖ')) { // Don't re-enable completed buttons
            btn.disabled = disable;
            if (disable) {
                btn.style.cursor = 'not-allowed';
                btn.style.opacity = '0.6';
            } else {
                btn.style.cursor = 'pointer';
                btn.style.opacity = '1';
            }
        }
    });
}

function goBackToGenerator() {
    window.location.href = '/';
}

function showStatus(message, type) {
    const statusDiv = document.getElementById('statusMessage');
    let iconClass = '';

    if (type === 'loading') {
        iconClass = '<div class="spinner"></div>';
    }

    statusDiv.innerHTML = `<div class="status-message status-${type}">${iconClass}${message}</div>`;

    if (type === 'success') {
        setTimeout(() => {
            statusDiv.innerHTML = '';
        }, 5000);
    } else if (type === 'error') {
        setTimeout(() => {
            statusDiv.innerHTML = '';
        }, 10000);
    }
}
</script>
{% endblock %}