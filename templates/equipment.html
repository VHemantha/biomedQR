{% extends "base.html" %}

{% block title %}Equipment {{ equipment_id }} - Actions{% endblock %}

{% block content %}
<button class="back-btn" onclick="goBackToGenerator()">â† Back to Generator</button>

<div class="equipment-info">
Â  Â  ğŸ­ Item: <span style="color: #667eea;">{{ equipment_id }}</span>
</div>

<div class="welcome-section">
Â  Â  <h2 class="welcome-title">Welcome to Equipment Portal</h2>
Â  Â  <p class="welcome-subtitle" id="welcomeSubtitle">Loading equipment data...</p>
</div>

<div id="loadingIndicator" style="text-align: center; margin: 30px 0;">
Â  Â  <div class="spinner" style="margin: 0 auto;"></div>
Â  Â  <p style="margin-top: 10px; color: #667eea; font-weight: 600;">Fetching master data...</p>
</div>

<div id="masterDataForm" class="master-data-form" style="display: none;">
Â  Â  <h3 style="color: #667eea; margin-bottom: 20px;">Equipment Details</h3>
Â  Â  
Â  Â  <div class="form-group">
Â  Â  Â  Â  <label for="form-itemID">Item ID:</label>
Â  Â  Â  Â  <input type="text" id="form-itemID" readonly style="background-color: #f5f5f5;">
Â  Â  </div>
Â  Â  
Â  Â  <div class="form-group">
Â  Â  Â  Â  <label for="form-productHospital">Hospital:</label>
Â  Â  Â  Â  Â  Â  Â  Â  <input type="text" id="form-productHospital" readonly style="background-color: #f5f5f5;">
Â  Â  </div>
Â  Â  <div class="form-group">
Â  Â  Â  Â  <label for="form-productLocation">Location:</label>
Â  Â  Â  Â  Â  Â  Â  Â  <input type="text" id="form-productLocation" readonly style="background-color: #f5f5f5;">
Â  Â  </div>
Â  Â  <div class="form-group">
Â  Â  Â  Â  <label for="form-productModel">Product Model:</label>
Â  Â  Â  Â  <input type="text" id="form-productModel" readonly style="background-color: #f5f5f5;">
Â  Â  </div>
Â  Â  
Â  Â  <div class="form-group">
Â  Â  Â  Â  <label for="form-serialNumber">Serial Number:</label>
Â  Â  Â  Â  <input type="text" id="form-serialNumber" readonly style="background-color: #f5f5f5;">
Â  Â  </div>
Â  Â  
Â  Â  <div class="form-group">
Â  Â  Â  Â  <label for="form-supplierName">Supplier Name:</label>
Â  Â  Â  Â  <input type="text" id="form-supplierName" readonly style="background-color: #f5f5f5;">
Â  Â  </div>
Â  Â  
Â  Â  <div class="form-group">
Â  Â  Â  Â  <label for="form-unit">Unit:</label>
Â  Â  Â  Â  <input type="text" id="form-unit" readonly style="background-color: #f5f5f5;">
Â  Â  </div>
Â  Â  
Â  Â  <div class="form-group">
Â  Â  Â  Â  <label for="form-createdDate">Created Date:</label>
Â  Â  Â  Â  <input type="text" id="form-createdDate" readonly style="background-color: #f5f5f5;">
Â  Â  </div>
Â  Â  
Â  Â  <div class="form-group">
Â  Â  Â  Â  <label for="form-lastUpdatedDate">Last Updated Date:</label>
Â  Â  Â  Â  <input type="text" id="form-lastUpdatedDate" readonly style="background-color: #f5f5f5;">
Â  Â  </div>
Â  Â  
Â  Â  Â  Â  <div class="form-group">
Â  Â  Â  Â  <label for="form-contactNumber">Contact Number: <span style="color: #fc466b;">*</span></label>
Â  Â  Â  Â  <input type="tel" id="form-contactNumber" placeholder="Enter contact number" required style="background-color: #ffffff; border: 2px solid #667eea;">
Â  Â  Â  Â  <small style="color: #718096; font-size: 12px;">Required field - Please enter your contact number</small>
Â  Â  </div>
</div>

<div class="action-options" id="actionOptions" style="opacity: 0.5; pointer-events: none;">
Â  Â  <button class="action-btn repair" onclick="selectAction('repair')" id="repairBtn" disabled>
Â  Â  Â  Â  <div class="action-icon">ğŸ”§</div>
Â  Â  Â  Â  <div>Repair</div>
Â  Â  </button>
Â  Â  
Â  Â  <button class="action-btn training" onclick="selectAction('user_training')" id="trainingBtn" disabled>
Â  Â  Â  Â  <div class="action-icon">ğŸ“š</div>
Â  Â  Â  Â  <div>User Training</div>
Â  Â  </button>
Â  Â  
Â  Â  <button class="action-btn maintenance" onclick="selectAction('one_time_service')" id="maintenanceBtn" disabled>
Â  Â  Â  Â  <div class="action-icon">âš™ï¸</div>
Â  Â  Â  Â  <div>One time service request</div>
Â  Â  </button>
Â  Â  
Â  Â  <button class="action-btn status" onclick="selectAction('consumer_request')" id="statusBtn" disabled>
Â  Â  Â  Â  <div class="action-icon">ğŸ“Š</div>
Â  Â  Â  Â  <div>Consumer request</div>
Â  Â  </button>
</div>

<div id="statusMessage"></div>
{% endblock %}

{% block extra_scripts %}
<script>
// Application state
const currentEquipmentId = '{{ equipment_id }}';
// Set initial values from Jinja context to fallback if API fails/missing data
let hospital = '{{ hospital | default("", true) }}'; // Added default and strict filtering
let locationName = '{{ location | default("", true) }}'; // Renamed 'location' to 'locationName' to avoid conflict with the local 'location' object
let unitCode = '{{ unit_code | default("", true) }}';
let serialNumber = '{{ serial_number | default("", true) }}';
let supplierName = '{{ supplier_name | default("", true) }}';
let unit = '{{ unit | default("", true) }}';
let itemId = '{{ item_id | default("", true) }}';
let masterDataLoaded = false;
let contactNumber = '';
let modality = ''; // Added modality variable (mapped from productModel)

// Auto-fetch master data when page loads
window.addEventListener('DOMContentLoaded', function() {
Â  Â  // Automatically fetch master data on page load
Â  Â  fetchAndMapMasterData();
});

function fetchAndMapMasterData() {
Â  Â  const loadingIndicator = document.getElementById('loadingIndicator');
Â  Â  const formSection = document.getElementById('masterDataForm');
Â  Â  const welcomeSubtitle = document.getElementById('welcomeSubtitle');

Â  Â  // Reset masterDataLoaded and re-show loading indicator content if retrying
Â  Â  masterDataLoaded = false;
Â  Â  if (loadingIndicator) {
Â  Â  Â  Â  loadingIndicator.innerHTML = `
Â  Â  Â  Â  Â  Â  <div class="spinner" style="margin: 0 auto;"></div>
Â  Â  Â  Â  Â  Â  <p style="margin-top: 10px; color: #667eea; font-weight: 600;">Fetching master data...</p>
Â  Â  Â  Â  `;
Â  Â  Â  Â  loadingIndicator.style.display = 'block';
Â  Â  }
Â  Â  // Hide form section while loading
Â  Â  formSection.style.display = 'none';

Â  Â  showStatus('Fetching master data from API...', 'loading');

Â  Â  // **Correction 1: Use itemId for the API call** (Original used item_id which is a template var)
Â  Â  fetch(`/api/get_master_data/${itemId}`)
Â  Â  Â  Â  .then(response => {
Â  Â  Â  Â  Â  Â  if (!response.ok) {
Â  Â  Â  Â  Â  Â  Â  Â  throw new Error(`HTTP error! status: ${response.status}`);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  return response.json();
Â  Â  Â  Â  })
Â  Â  Â  Â  .then(data => {
Â  Â  Â  Â  Â  Â  if (data.success) {
Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  // Map the fetched data to form fields
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('form-itemID').value = data.data.itemID || 'N/A';
Â  Â  Â  Â  Â  Â  Â  Â  // **Correction 2: Mapping location fields**
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('form-productHospital').value = data.data.productHospital || data.data.productLocation || 'N/A'; // Assuming productHospital is the correct field, falling back to productLocation
Â  Â  Â  Â  Â  Â  Â  Â  // Corrected ID usage: form-productLocation maps to location
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('form-productLocation').value = data.data.location || 'N/A';
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('form-productModel').value = data.data.productModel || 'N/A';
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('form-serialNumber').value = data.data.serialNumber || 'N/A';
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('form-supplierName').value = data.data.supplierName || 'N/A';
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('form-unit').value = data.data.unit || 'N/A';
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('form-createdDate').value = data.data.createdDate || 'N/A';
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('form-lastUpdatedDate').value = data.data.lastUpdatedDate || 'N/A';
Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  // Contact Number from API (if exists)
Â  Â  Â  Â  Â  Â  Â  Â  if (data.data.contactNumber) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('form-contactNumber').value = data.data.contactNumber;
Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  // **Correction 3: Update local variables consistently**
Â  Â  Â  Â  Â  Â  Â  Â  // Note: 'productLocation' in data maps to 'hospital' locally
Â  Â  Â  Â  Â  Â  Â  Â  hospital = data.data.productHospital || data.data.productLocation || hospital;
Â  Â  Â  Â  Â  Â  Â  Â  locationName = data.data.location || locationName; // Use locationName var
Â  Â  Â  Â  Â  Â  Â  Â  unitCode = data.data.productModel || unitCode;
Â  Â  Â  Â  Â  Â  Â  Â  serialNumber = data.data.serialNumber || serialNumber;
Â  Â  Â  Â  Â  Â  Â  Â  supplierName = data.data.supplierName || supplierName;
Â  Â  Â  Â  Â  Â  Â  Â  modality = data.data.productModel || modality; // Modality is correctly mapped from productModel
Â  Â  Â  Â  Â  Â  Â  Â  unit = data.data.unit || unit;

Â  Â  Â  Â  Â  Â  Â  Â  // Hide loading indicator
Â  Â  Â  Â  Â  Â  Â  Â  if (loadingIndicator) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  loadingIndicator.style.display = 'none';
Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  // Show the form section
Â  Â  Â  Â  Â  Â  Â  Â  formSection.style.display = 'block';

Â  Â  Â  Â  Â  Â  Â  Â  // Update welcome subtitle
Â  Â  Â  Â  Â  Â  Â  Â  if (welcomeSubtitle) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  welcomeSubtitle.textContent = 'Equipment details loaded. Please ensure contact number is correct and select an action:';
Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  // Enable action buttons
Â  Â  Â  Â  Â  Â  Â  Â  enableActionButtons();
Â  Â  Â  Â  Â  Â  Â  Â  masterDataLoaded = true;

Â  Â  Â  Â  Â  Â  Â  Â  showStatus('Master data loaded successfully! Please enter contact number and select an action.', 'success');
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  // **Correction 4: Consolidate error logic for API failure**
Â  Â  Â  Â  Â  Â  Â  Â  handleMasterDataError(data.error || 'Unknown API error');
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  })
Â  Â  Â  Â  .catch(error => {
Â  Â  Â  Â  Â  Â  console.error('Fetch error:', error);
Â  Â  Â  Â  Â  Â  // **Correction 5: Consolidate error logic for network failure**
Â  Â  Â  Â  Â  Â  handleMasterDataError(error.message || 'Network or server communication failed');
Â  Â  Â  Â  });
}

// **New function to handle master data errors (DRY principle)**
function handleMasterDataError(errorMessage) {
Â  Â  const loadingIndicator = document.getElementById('loadingIndicator');
Â  Â  const welcomeSubtitle = document.getElementById('welcomeSubtitle');
Â  Â  
Â  Â  if (loadingIndicator) {
Â  Â  Â  Â  loadingIndicator.style.display = 'none';
Â  Â  }

Â  Â  if (welcomeSubtitle) {
Â  Â  Â  Â  welcomeSubtitle.innerHTML = `<span style="color: #fc466b;">Failed to load equipment data</span>`;
Â  Â  }

Â  Â  showStatus(`Error: ${errorMessage}.`, 'error');

Â  Â  // Show retry button
Â  Â  if (loadingIndicator) {
Â  Â  Â  Â  loadingIndicator.innerHTML = `
Â  Â  Â  Â  Â  Â  <button class="master-data-btn" onclick="fetchAndMapMasterData()" style="margin-top: 20px;">
Â  Â  Â  Â  Â  Â  Â  Â  <div class="action-icon">ğŸ”„</div>
Â  Â  Â  Â  Â  Â  Â  Â  <div>Retry Loading Data</div>
Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  `;
Â  Â  Â  Â  loadingIndicator.style.display = 'block';
Â  Â  }
}


function enableActionButtons() {
Â  Â  const actionOptions = document.getElementById('actionOptions');
Â  Â  const actionBtns = document.querySelectorAll('.action-btn');
Â  Â  
Â  Â  // Enable the action section
Â  Â  actionOptions.style.opacity = '1';
Â  Â  actionOptions.style.pointerEvents = 'auto';
Â  Â  
Â  Â  // Enable all action buttons that haven't been completed
Â  Â  actionBtns.forEach(btn => {
Â  Â  Â  Â  if (!btn.innerHTML.includes('âœ…')) { // Do not re-enable buttons that were successfully clicked
Â  Â  Â  Â  Â  Â  btn.disabled = false;
Â  Â  Â  Â  Â  Â  btn.style.cursor = 'pointer';
Â  Â  Â  Â  Â  Â  btn.style.opacity = '1';
Â  Â  Â  Â  }
Â  Â  });
}

function selectAction(action) {
Â  Â  if (!masterDataLoaded) {
Â  Â  Â  Â  showStatus('Please wait for master data to load or retry loading it.', 'error');
Â  Â  Â  Â  return;
Â  Â  }

Â  Â  // Get contact number from the input field
Â  Â  contactNumber = document.getElementById('form-contactNumber').value.trim();
Â  Â  
Â  Â  // Validate contact number
Â  Â  if (!contactNumber) {
Â  Â  Â  Â  showStatus('Please enter a contact number before submitting a request', 'error');
Â  Â  Â  Â  const contactInput = document.getElementById('form-contactNumber');
Â  Â  Â  Â  contactInput.focus();
Â  Â  Â  Â  contactInput.style.borderColor = '#fc466b';
Â  Â  Â  Â  return;
Â  Â  }

Â  Â  // Reset border color
Â  Â  document.getElementById('form-contactNumber').style.borderColor = '#667eea';

Â  Â  const actionNames = {
Â  Â  Â  Â  'repair': 'Repair',
Â  Â  Â  Â  'user_training': 'User Training',
Â  Â  Â  Â  'one_time_service': 'One Time Service',
Â  Â  Â  Â  'consumer_request': 'Consumer Request'
Â  Â  };
Â  Â  
Â  Â  const selectedAction = actionNames[action];
Â  Â  
Â  Â  // Disable all action buttons while processing
Â  Â  disableActionButtons(true);
Â  Â  
Â  Â  showStatus(`${selectedAction} selected for equipment ${itemId}. Processing...`, 'loading');
Â  Â  
Â  Â  // Make API request to Flask backend
Â  Â  fetch('/api/action', {
Â  Â  Â  Â  method: 'POST',
Â  Â  Â  Â  headers: {
Â  Â  Â  Â  Â  Â  'Content-Type': 'application/json',
Â  Â  Â  Â  },
Â  Â  Â  Â  body: JSON.stringify({
Â  Â  Â  Â  Â  Â  action: action,
Â  Â  Â  Â  Â  Â  equipment_id: currentEquipmentId,
Â  Â  Â  Â  Â  Â  hospital: hospital,
Â  Â  Â  Â  Â  Â  // **Correction 6: Use locationName instead of unit_code (which is productModel)**
Â  Â  Â  Â  Â  Â  location: locationName, 
Â  Â  Â  Â  Â  Â  unit_code: unitCode, 
Â  Â  Â  Â  Â  Â  serial_number: serialNumber,
Â  Â  Â  Â  Â  Â  supplier_name: supplierName,
Â  Â  Â  Â  Â  Â  unit: unit,
Â  Â  Â  Â  Â  Â  item_id: itemId,
Â  Â  Â  Â  Â  Â  contact_number: contactNumber Â // Send contact number
Â  Â  Â  Â  })
Â  Â  })
Â  Â  .then(response => {
Â  Â  Â  Â  if (!response.ok) {
Â  Â  Â  Â  Â  Â  throw new Error(`HTTP error! status: ${response.status}`);
Â  Â  Â  Â  }
Â  Â  Â  Â  return response.json();
Â  Â  })
Â  Â  .then(data => {
Â  Â  Â  Â  if (data.success) {
Â  Â  Â  Â  Â  Â  showStatus(data.message, 'success');
Â  Â  Â  Â  Â  Â  // Disable the specific button that was clicked
Â  Â  Â  Â  Â  Â  disableSpecificButton(action);
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  showStatus(`Failed: ${data.error || 'Unknown error during action submission'}`, 'error');
Â  Â  Â  Â  }
Â  Â  })
Â  Â  .catch(error => {
Â  Â  Â  Â  console.error('Action error:', error);
Â  Â  Â  Â  showStatus(`Failed to submit ${selectedAction.toLowerCase()} request: ${error.message}`, 'error');
Â  Â  })
Â  Â  .finally(() => {
Â  Â  Â  Â  // Only re-enable all buttons that haven't been marked 'Completed'
Â  Â  Â  Â  disableActionButtons(false); 
Â  Â  });
}

function disableSpecificButton(action) {
Â  Â  // Map action to button ID
Â  Â  const actionToButtonId = {
Â  Â  Â  Â  'repair': 'repairBtn',
Â  Â  Â  Â  'user_training': 'trainingBtn',
Â  Â  Â  Â  'one_time_service': 'maintenanceBtn',
Â  Â  Â  Â  'consumer_request': 'statusBtn'
Â  Â  };
Â  Â  
Â  Â  const buttonId = actionToButtonId[action];
Â  Â  if (buttonId) {
Â  Â  Â  Â  const button = document.getElementById(buttonId);
Â  Â  Â  Â  if (button) {
Â  Â  Â  Â  Â  Â  button.disabled = true;
Â  Â  Â  Â  Â  Â  button.style.opacity = '0.6';
Â  Â  Â  Â  Â  Â  button.style.cursor = 'not-allowed';
Â  Â  Â  Â  Â  Â  button.innerHTML = `
Â  Â  Â  Â  Â  Â  Â  Â  <div class="action-icon">âœ…</div>
Â  Â  Â  Â  Â  Â  Â  Â  <div>Completed</div>
Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  }
Â  Â  }
}

function disableActionButtons(disable) {
Â  Â  const actionBtns = document.querySelectorAll('.action-btn');
Â  Â  actionBtns.forEach(btn => {
Â  Â  Â  Â  // Check if the button has been marked as 'Completed'
Â  Â  Â  Â  const isCompleted = btn.innerHTML.includes('âœ…');
Â  Â  Â  Â  
Â  Â  Â  Â  if (!isCompleted) { 
Â  Â  Â  Â  Â  Â  btn.disabled = disable;
Â  Â  Â  Â  Â  Â  if (disable) {
Â  Â  Â  Â  Â  Â  Â  Â  btn.style.cursor = 'not-allowed';
Â  Â  Â  Â  Â  Â  Â  Â  btn.style.opacity = '0.6';
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  btn.style.cursor = 'pointer';
Â  Â  Â  Â  Â  Â  Â  Â  btn.style.opacity = '1';
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  } else if (isCompleted && !disable) {
Â  Â  Â  Â  Â  Â  // Ensure completed buttons remain disabled and styled correctly even when re-enabling others
Â  Â  Â  Â  Â  Â  btn.disabled = true;
Â  Â  Â  Â  Â  Â  btn.style.cursor = 'not-allowed';
Â  Â  Â  Â  Â  Â  btn.style.opacity = '0.6';
Â  Â  Â  Â  }
Â  Â  });
}

function goBackToGenerator() {
Â  Â  window.location.href = '/';
}

function showStatus(message, type) {
Â  Â  const statusDiv = document.getElementById('statusMessage');
Â  Â  // **Correction 7: Added icons for success/error for better visual feedback**
Â  Â  let icon = ''; 
Â  Â  let spinner = '';

Â  Â  if (type === 'loading') {
Â  Â  Â  Â  spinner = '<div class="spinner"></div>';
Â  Â  } else if (type === 'success') {
Â  Â  Â  Â  icon = 'âœ”ï¸ ';
Â  Â  } else if (type === 'error') {
Â  Â  Â  Â  icon = 'âŒ ';
Â  Â  }

Â  Â  statusDiv.innerHTML = `<div class="status-message status-${type}">${spinner}${icon}${message}</div>`;

Â  Â  // **Correction 8: Clear status for all types after a delay**
Â  Â  if (type !== 'loading') {
Â  Â  Â  Â  const timeout = type === 'success' ? 5000 : 10000;
Â  Â  Â  Â  setTimeout(() => {
Â  Â  Â  Â  Â  Â  statusDiv.innerHTML = '';
Â  Â  Â  Â  }, timeout);
Â  Â  }
}
</script>
{% endblock %}