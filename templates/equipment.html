{% extends "base.html" %}

{% block title %}Equipment {{ equipment_id }} - Actions{% endblock %}

{% block content %}
<button class="back-btn" onclick="goBackToGenerator()">‚Üê Back to Generator</button>

<div class="equipment-info">
    üè≠ Item: <span style="color: #667eea;">{{ equipment_id }}</span>
</div>

<div class="welcome-section">
    <h2 class="welcome-title">Welcome to Equipment Portal</h2>
    <p class="welcome-subtitle">Scan QR/Barcode to auto-load data or click button below:</p>
</div>

<!-- Debug Info Panel (Remove after testing) -->
<div id="debugPanel" style="background: #fff3cd; border: 2px solid #ffc107; padding: 15px; margin: 20px 0; border-radius: 8px; font-family: monospace; font-size: 12px;">
    <strong>üêõ Debug Info:</strong><br>
    <div id="debugContent">Initializing...</div>
</div>

<!-- Scanning Status Indicator -->
<div id="scanningIndicator" class="scanning-indicator" style="display: none; text-align: center; margin: 20px 0; padding: 15px; background-color: #e6fffa; border-left: 4px solid #38b6a8; border-radius: 4px;">
    <div class="spinner" style="display: inline-block; margin-right: 10px;"></div>
    <span id="scanningText" style="color: #38b6a8; font-weight: 500;">üì± Scanning detected... Auto-fetching data</span>
</div>

<!-- Get Master Data Button -->
<div id="getMasterDataSection" style="text-align: center; margin: 30px 0;">
    <button class="master-data-btn" onclick="fetchAndMapMasterData()" id="getMasterDataBtn">
        <div class="action-icon">üîç</div>
        <div>Get Master Data</div>
    </button>
    <p style="color: #718096; margin-top: 10px; font-size: 14px;">
        üì± Tip: Scan a barcode/QR code to auto-load data
    </p>
</div>

<!-- Master Data Form Section (Initially Hidden) -->
<div id="masterDataForm" class="master-data-form" style="display: none;">
    <h3 style="color: #667eea; margin-bottom: 20px;">üìã Equipment Details</h3>
    
    <div class="form-group">
        <label for="form-itemID">Item ID:</label>
        <input type="text" id="form-itemID" readonly style="background-color: #f5f5f5;">
    </div>
    
    <div class="form-group">
        <label for="form-area">Area:</label>
        <input type="text" id="form-area" readonly style="background-color: #f5f5f5;">
    </div>
    
    <div class="form-group">
        <label for="form-location">Location:</label>
        <input type="text" id="form-location" readonly style="background-color: #f5f5f5;">
    </div>
    
    <div class="form-group">
        <label for="form-productLocation">Hospital / Product Location:</label>
        <input type="text" id="form-productLocation" readonly style="background-color: #f5f5f5;">
    </div>
    
    <div class="form-group">
        <label for="form-productModel">Product Model / Modality:</label>
        <input type="text" id="form-productModel" readonly style="background-color: #f5f5f5;">
    </div>
    
    <div class="form-group">
        <label for="form-serialNumber">Serial Number:</label>
        <input type="text" id="form-serialNumber" readonly style="background-color: #f5f5f5;">
    </div>
    
    <div class="form-group">
        <label for="form-supplierName">Supplier Name:</label>
        <input type="text" id="form-supplierName" readonly style="background-color: #f5f5f5;">
    </div>
    
    <div class="form-group">
        <label for="form-unit">Unit:</label>
        <input type="text" id="form-unit" readonly style="background-color: #f5f5f5;">
    </div>

    <div class="form-group">
        <label for="form-productType">Product Type:</label>
        <input type="text" id="form-productType" readonly style="background-color: #f5f5f5;">
    </div>

    <div class="form-group">
        <label for="form-modality">Modality:</label>
        <input type="text" id="form-modality" readonly style="background-color: #f5f5f5;">
    </div>

    <div class="form-group">
        <label for="form-city">City:</label>
        <input type="text" id="form-city" readonly style="background-color: #f5f5f5;">
    </div>

    <div class="form-group">
        <label for="form-createdDate">Created Date:</label>
        <input type="text" id="form-createdDate" readonly style="background-color: #f5f5f5;">
    </div>

    <div class="form-group">
        <label for="form-lastUpdatedDate">Last Updated Date:</label>
        <input type="text" id="form-lastUpdatedDate" readonly style="background-color: #f5f5f5;">
    </div>

    <!-- Contact Number - Editable Field -->
    <div class="form-group">
        <label for="form-contactNumber">Contact Number: <span style="color: #fc466b;">*</span></label>
        <input type="tel" id="form-contactNumber" placeholder="Enter contact number" required style="background-color: #ffffff; border: 2px solid #667eea;">
        <small style="color: #718096; font-size: 12px;">Required field - Please enter your contact number</small>
    </div>
</div>

<!-- Action Options (Initially Disabled) -->
<div class="action-options" id="actionOptions" style="opacity: 0.5; pointer-events: none;">
    <button class="action-btn repair" onclick="selectActionRepair('repair')" id="repairBtn" disabled>
        <div class="action-icon">üîß</div>
        <div>Repair</div>
    </button>
    
    <button class="action-btn training" onclick="selectActionUserTraining('user_training')" id="trainingBtn" disabled>
        <div class="action-icon">üìö</div>
        <div>User Training</div>
    </button>
    
    <button class="action-btn ots" onclick="selectActionOTS('one_time_service')" id="otsBtn" disabled>
        <div class="action-icon">‚öôÔ∏è</div>
        <div>One Time Service</div>
    </button>

    <button class="action-btn consumable" onclick="selectActionConsumable('consumable_request')" id="consumableBtn" disabled>
        <div class="action-icon">üíâ</div>
        <div>Consumable Request</div>
    </button>
</div>

<div id="statusMessage"></div>
{% endblock %}

{% block extra_scripts %}
<script>
// ============================================
// APPLICATION STATE & CONFIGURATION
// ============================================
const currentEquipmentId = '{{ equipment_id }}';
let hospital = `{{ hospital }}`;
let unitCode = `{{ unit_code }}`;
let serialNumber = `{{ serial_number }}`;
let supplierName = `{{ supplier_name }}`;
let unit = `{{ unit }}`;
let itemId = `{{ item_id }}`;
let productModel = `{{ productModel }}`;
let area = '';
let equipmentLocation = '';
let productType = '';
let modality = '';
let city = '';
let masterDataLoaded = false;
let contactNumber = '';
let autoScannedData = false;

// Barcode/QR Scanner Detection Variables
let scanBuffer = '';
let scanTimeout = null;
let isScanning = false;
const SCAN_TIMEOUT_MS = 100;
const MIN_SCAN_LENGTH = 3;
const MAX_SCAN_LENGTH = 50;

// ============================================
// DEBUG HELPER FUNCTION
// ============================================
function updateDebugPanel(info) {
    const debugContent = document.getElementById('debugContent');
    const timestamp = new Date().toLocaleTimeString();
    debugContent.innerHTML = `
        <strong>[${timestamp}]</strong><br>
        Equipment ID: <span style="color: blue;">${currentEquipmentId}</span><br>
        Item ID: <span style="color: ${itemId && itemId !== '' && itemId !== 'None' ? 'green' : 'red'};">${itemId || 'NOT SET'}</span><br>
        Hospital: ${hospital || 'N/A'}<br>
        Serial: ${serialNumber || 'N/A'}<br>
        Auto-Scanned: ${autoScannedData ? 'YES' : 'NO'}<br>
        Master Data Loaded: ${masterDataLoaded ? 'YES' : 'NO'}<br>
        <hr style="margin: 10px 0;">
        ${info || 'Waiting for action...'}
    `;
}

// ============================================
// PAGE INITIALIZATION
// ============================================
document.addEventListener('DOMContentLoaded', function() {
    console.log('='.repeat(50));
    console.log('üöÄ EQUIPMENT PORTAL INITIALIZED');
    console.log('='.repeat(50));
    console.log('Current Equipment ID:', currentEquipmentId);
    console.log('Item ID from template:', itemId);
    console.log('Item ID type:', typeof itemId);
    console.log('Item ID length:', itemId ? itemId.length : 0);
    console.log('Hospital:', hospital);
    console.log('Unit Code:', unitCode);
    console.log('Serial Number:', serialNumber);
    console.log('='.repeat(50));
    
    updateDebugPanel('Page loaded, checking itemId...');
    
    // Initialize barcode scanner detection
    initializeBarcodeScanner();
    
    // Check if itemId is valid and trigger auto-fetch
    const isValidItemId = itemId && 
                          itemId.trim() !== '' && 
                          itemId !== 'None' && 
                          itemId !== 'null' && 
                          itemId !== 'undefined';
    
    console.log('Is Valid Item ID?', isValidItemId);
    
    if (isValidItemId) {
        console.log('‚úÖ Valid Item ID found:', itemId);
        updateDebugPanel(`Valid Item ID found: ${itemId}<br>Triggering auto-fetch in 1 second...`);
        
        // Auto-fetch after short delay
        setTimeout(() => {
            console.log('‚è∞ Timeout triggered - calling fetchAndMapMasterData()');
            updateDebugPanel(`Auto-fetching data for: ${itemId}`);
            fetchAndMapMasterData();
        }, 1000);
    } else {
        console.log('‚ùå No valid Item ID found');
        updateDebugPanel('‚ùå No valid Item ID. Please scan QR code or click "Get Master Data"');
    }
});

// ============================================
// BARCODE/QR SCANNER DETECTION
// ============================================
function initializeBarcodeScanner() {
    console.log('üîç Barcode scanner detection initialized');
    updateDebugPanel('Scanner detection active. Waiting for scan...');
    
    document.addEventListener('keydown', function(event) {
        // Ignore keyboard input if user is typing in an input field
        if (event.target.tagName === 'INPUT' || event.target.tagName === 'TEXTAREA') {
            console.log('‚è≠Ô∏è Ignoring keypress - user typing in input field');
            return;
        }
        
        // Start scanning detection
        if (!isScanning) {
            isScanning = true;
            scanBuffer = '';
            showScanningIndicator(true);
            console.log('üì± Scan started...');
            updateDebugPanel('üì± Scanning in progress...');
        }
        
        // Clear previous timeout
        if (scanTimeout) {
            clearTimeout(scanTimeout);
        }
        
        // Accumulate characters (only single printable characters)
        if (event.key.length === 1) {
            scanBuffer += event.key;
            console.log('Buffer:', scanBuffer);
            
            // Prevent buffer overflow
            if (scanBuffer.length > MAX_SCAN_LENGTH) {
                console.log('‚ö†Ô∏è Scan buffer overflow, resetting...');
                updateDebugPanel('‚ö†Ô∏è Scan too long - resetting');
                resetScanner();
                return;
            }
        }
        
        // Enter key typically signals end of barcode scan
        if (event.key === 'Enter' && scanBuffer.length >= MIN_SCAN_LENGTH) {
            event.preventDefault();
            console.log('‚úÖ Scan completed (Enter key):', scanBuffer);
            updateDebugPanel(`‚úÖ Scan completed: ${scanBuffer}`);
            handleScanComplete(scanBuffer.trim());
            resetScanner();
            return;
        }
        
        // Set timeout for auto-completion (if no Enter key)
        scanTimeout = setTimeout(() => {
            if (scanBuffer.length >= MIN_SCAN_LENGTH) {
                console.log('‚úÖ Scan completed (timeout):', scanBuffer);
                updateDebugPanel(`‚úÖ Scan completed (timeout): ${scanBuffer}`);
                handleScanComplete(scanBuffer.trim());
            }
            resetScanner();
        }, SCAN_TIMEOUT_MS);
    });
}

function resetScanner() {
    scanBuffer = '';
    isScanning = false;
    showScanningIndicator(false);
    if (scanTimeout) {
        clearTimeout(scanTimeout);
        scanTimeout = null;
    }
    console.log('üîÑ Scanner reset');
}

function showScanningIndicator(show) {
    const indicator = document.getElementById('scanningIndicator');
    if (show) {
        indicator.style.display = 'block';
    } else {
        setTimeout(() => {
            indicator.style.display = 'none';
        }, 800);
    }
}

// ============================================
// HANDLE SCAN COMPLETION
// ============================================
function handleScanComplete(scannedData) {
    console.log('üîç Processing scanned data:', scannedData);
    updateDebugPanel(`Processing scan: ${scannedData}`);
    
    // Try to extract Item ID from scanned data
    const itemIdMatch = scannedData.match(/([A-Z]{2,}\d+|[A-Z]+-\d+|\d{4,})/i);
    
    if (itemIdMatch || scannedData.length >= MIN_SCAN_LENGTH) {
        autoScannedData = true;
        
        // Update itemId
        if (itemIdMatch) {
            itemId = itemIdMatch[0].toUpperCase();
            console.log('üìå Extracted Item ID:', itemId);
        } else {
            itemId = scannedData;
            console.log('üìå Using full scan as Item ID:', itemId);
        }
        
        updateDebugPanel(`Item ID set to: ${itemId}<br>Triggering fetch...`);
        
        // Update equipment info display
        const equipmentInfoSpan = document.querySelector('.equipment-info span');
        if (equipmentInfoSpan) {
            equipmentInfoSpan.textContent = itemId;
        }
        
        // Automatically trigger data fetch
        console.log('üöÄ Auto-triggering data fetch...');
        showStatus('üì± Scan detected! Fetching data for Item ID: ' + itemId, 'loading');
        
        setTimeout(() => {
            fetchAndMapMasterData();
        }, 300);
        
    } else {
        console.log('‚ùå Invalid scan - too short or invalid format');
        updateDebugPanel('‚ùå Invalid scan format');
        showStatus('‚ö†Ô∏è Invalid scan. Please try again or enter Item ID manually.', 'error');
    }
}

// ============================================
// FETCH AND MAP MASTER DATA
// ============================================
function fetchAndMapMasterData() {
    console.log('='.repeat(50));
    console.log('üì° FETCH AND MAP MASTER DATA CALLED');
    console.log('='.repeat(50));
    
    const btn = document.getElementById('getMasterDataBtn');
    const formSection = document.getElementById('masterDataForm');
    const actionOptions = document.getElementById('actionOptions');

    // Validate itemId
    console.log('Validating itemId:', itemId);
    console.log('Type:', typeof itemId);
    console.log('Value:', itemId);
    console.log('Trimmed:', itemId ? itemId.trim() : 'N/A');
    
    if (!itemId || itemId.trim() === '' || itemId === 'None' || itemId === 'null' || itemId === 'undefined') {
        console.log('‚ùå INVALID ITEM ID');
        updateDebugPanel('‚ùå Invalid Item ID - cannot fetch');
        showStatus('‚ùå Item ID is missing. Please scan a QR code or enter Item ID.', 'error');
        return;
    }

    console.log('‚úÖ Item ID is valid:', itemId);
    updateDebugPanel(`Fetching data for: ${itemId}...`);

    // Disable button while loading
    if (btn) {
        btn.disabled = true;
        btn.innerHTML = '<div class="spinner"></div><div>Loading...</div>';
    }

    const source = autoScannedData ? 'üîç Auto-scan' : 'üëÜ Manual';
    showStatus(`${source} - Fetching master data for Item ID: ${itemId}...`, 'loading');

    const apiUrl = `/api/get_master_data/${encodeURIComponent(itemId)}`;
    console.log('API URL:', apiUrl);

    // Fetch master data from backend API
    fetch(apiUrl)
        .then(response => {
            console.log('üì• API Response received');
            console.log('Status:', response.status);
            console.log('Status Text:', response.statusText);
            console.log('OK:', response.ok);
            
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            return response.json();
        })
        .then(data => {
            console.log('üì¶ API Response Data:', data);
            updateDebugPanel(`API Response received. Success: ${data.success}`);
            
            if (data.success && data.data) {
                const apiData = data.data;
                console.log('API Data Object:', apiData);
                
                // ========================================
                // FIELD MAPPING: API Response -> HTML Form
                // ========================================
                console.log('Mapping fields...');
                
                // Core Fields
                document.getElementById('form-itemID').value = apiData.itemID || 'N/A';
                document.getElementById('form-area').value = apiData.area || 'N/A';
                document.getElementById('form-location').value = apiData.location || 'N/A';
                document.getElementById('form-productLocation').value = apiData.productLocation || 'N/A';
                document.getElementById('form-productModel').value = apiData.productModel || 'N/A';
                document.getElementById('form-serialNumber').value = apiData.serialNumber || 'N/A';
                document.getElementById('form-supplierName').value = apiData.supplierName || 'N/A';
                document.getElementById('form-unit').value = apiData.unit || 'N/A';
                document.getElementById('form-productType').value = apiData.productType || 'N/A';
                document.getElementById('form-modality').value = apiData.modality || 'N/A';
                document.getElementById('form-city').value = apiData.city || 'N/A';

                // Date Fields
                document.getElementById('form-createdDate').value = apiData.createdDate || 'N/A';
                document.getElementById('form-lastUpdatedDate').value = apiData.lastUpdatedDate || 'N/A';
                
                // Pre-fill contact number if available
                if (apiData.contactNumber) {
                    document.getElementById('form-contactNumber').value = apiData.contactNumber;
                }

                // Update local state variables
                area = apiData.area || '';
                equipmentLocation = apiData.location || '';
                hospital = apiData.productLocation || hospital;
                unitCode = apiData.productModel || unitCode;
                serialNumber = apiData.serialNumber || serialNumber;
                supplierName = apiData.supplierName || supplierName;
                unit = apiData.unit || unit;
                productModel = apiData.productModel || productModel;
                productType = apiData.productType || '';
                modality = apiData.modality || '';
                city = apiData.city || '';

                console.log('‚úÖ Data mapped successfully');
                console.log('State:', { area, equipmentLocation, hospital, unitCode, serialNumber, supplierName, unit, productModel, productType, modality, city });
                updateDebugPanel('‚úÖ Data loaded and mapped successfully!');

                // Show the form section with smooth scroll
                formSection.style.display = 'block';
                formSection.scrollIntoView({ behavior: 'smooth', block: 'nearest' });

                // Enable action buttons
                enableActionButtons();
                masterDataLoaded = true;

                // Update button to show success
                if (btn) {
                    btn.innerHTML = '<div class="action-icon">‚úÖ</div><div>Data Loaded Successfully</div>';
                    btn.style.backgroundColor = '#48bb78';
                    btn.style.cursor = 'default';
                }

                const successMessage = autoScannedData 
                    ? '‚úÖ Master data auto-loaded from scan! Please enter contact number and select an action.'
                    : '‚úÖ Master data loaded successfully! Please enter contact number and select an action.';
                
                showStatus(successMessage, 'success');
                
                // Focus on contact number field
                setTimeout(() => {
                    document.getElementById('form-contactNumber').focus();
                }, 500);

            } else {
                const errorMsg = data.error || 'Unknown error occurred';
                console.error('‚ùå API Error:', errorMsg);
                updateDebugPanel(`‚ùå API Error: ${errorMsg}`);
                showStatus(`‚ùå Error: ${errorMsg}`, 'error');
                
                // Re-enable button
                if (btn) {
                    btn.disabled = false;
                    btn.innerHTML = '<div class="action-icon">üîç</div><div>Get Master Data</div>';
                }
            }
        })
        .catch(error => {
            console.error('‚ùå Fetch error:', error);
            console.error('Error stack:', error.stack);
            updateDebugPanel(`‚ùå Fetch Error: ${error.message}`);
            showStatus(`‚ùå Failed to fetch master data: ${error.message}`, 'error');
            
            // Re-enable button
            if (btn) {
                btn.disabled = false;
                btn.innerHTML = '<div class="action-icon">üîç</div><div>Get Master Data</div>';
            }
        });
}

function enableActionButtons() {
    const actionOptions = document.getElementById('actionOptions');
    const actionBtns = document.querySelectorAll('.action-btn');
    
    // Enable the action section
    actionOptions.style.opacity = '1';
    actionOptions.style.pointerEvents = 'auto';
    
    // Enable all action buttons
    actionBtns.forEach(btn => {
        btn.disabled = false;
        btn.style.cursor = 'pointer';
    });
    
    console.log('‚úÖ Action buttons enabled');
}

// ============================================
// REPAIR REQUEST HANDLER
// ============================================
function selectActionRepair(action) {
    if (!masterDataLoaded) {
        showStatus('‚ö†Ô∏è Please load master data first', 'error');
        return;
    }

    contactNumber = document.getElementById('form-contactNumber').value.trim();

    if (!contactNumber) {
        showStatus('‚ö†Ô∏è Please enter a contact number', 'error');
        document.getElementById('form-contactNumber').focus();
        document.getElementById('form-contactNumber').style.borderColor = '#fc466b';
        return;
    }

    const contactRegex = /^[\d\s\+\-\(\)]{7,15}$/;
    if (!contactRegex.test(contactNumber)) {
        showStatus('‚ö†Ô∏è Please enter a valid contact number (7-15 digits)', 'error');
        document.getElementById('form-contactNumber').focus();
        document.getElementById('form-contactNumber').style.borderColor = '#fc466b';
        return;
    }

    document.getElementById('form-contactNumber').style.borderColor = '#667eea';

    const selectedAction = 'Repair Request';

    console.log('='.repeat(50));
    console.log('üîß REPAIR REQUEST SELECTED');
    console.log('='.repeat(50));
    updateDebugPanel(`Submitting ${selectedAction}...`);

    disableActionButtons(true);
    showStatus(`‚è≥ ${selectedAction} selected. Processing...`, 'loading');

    const requestPayload = {
        action: 'repair',
        equipment_id: currentEquipmentId,
        area: area,
        location: equipmentLocation,
        hospital: hospital,
        unit_code: unitCode,
        serial_number: serialNumber,
        supplier_name: supplierName,
        unit: unit,
        item_id: itemId,
        contact_number: contactNumber,
        product_model: productModel,
        product_type: productType,
        modality: modality,
        city: city
    };

    console.log('üì§ Request Payload:', JSON.stringify(requestPayload, null, 2));
    console.log('üì§ Endpoint: /api/Repair');
    console.log('='.repeat(50));

    fetch('/api/repair', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'Accept': 'application/json'
        },
        body: JSON.stringify(requestPayload)
    })
    .then(response => {
        console.log('üì• Response Status:', response.status);
        console.log('üì• Response OK:', response.ok);

        return response.json().then(data => {
            data._httpStatus = response.status;
            data._httpOk = response.ok;
            return data;
        }).catch(parseError => {
            console.error('‚ùå JSON Parse Error:', parseError);
            throw new Error(`Server returned invalid JSON (Status: ${response.status})`);
        });
    })
    .then(data => {
        console.log('üì¶ Response Data:', data);
        console.log('='.repeat(50));

        if (data.success) {
            updateDebugPanel(`‚úÖ ${selectedAction} completed!`);
            showStatus(`‚úÖ ${data.message || 'Request submitted successfully!'}`, 'success');
            disableSpecificButton('repair');
        } else {
            const errorMsg = data.error || 'Unknown error occurred';
            console.error('‚ùå API Error:', errorMsg);
            updateDebugPanel(`‚ùå ${selectedAction} failed: ${errorMsg}`);
            showStatus(`‚ùå Failed: ${errorMsg}`, 'error');
        }
    })
    .catch(error => {
        console.error('='.repeat(50));
        console.error('‚ùå Request Failed:', error);
        console.error('Error Message:', error.message);
        console.error('Error Stack:', error.stack);
        console.error('='.repeat(50));

        updateDebugPanel(`‚ùå Error: ${error.message}`);
        showStatus(`‚ùå Failed: ${error.message}`, 'error');
    })
    .finally(() => {
        disableActionButtons(false);
        console.log('üèÅ Request completed');
        console.log('='.repeat(50));
    });
}

// ============================================
// CONSUMABLE REQUEST HANDLER
// ============================================
function selectActionConsumable(action) {
    if (!masterDataLoaded) {
        showStatus('‚ö†Ô∏è Please load master data first', 'error');
        return;
    }

    contactNumber = document.getElementById('form-contactNumber').value.trim();

    if (!contactNumber) {
        showStatus('‚ö†Ô∏è Please enter a contact number', 'error');
        document.getElementById('form-contactNumber').focus();
        document.getElementById('form-contactNumber').style.borderColor = '#fc466b';
        return;
    }

    const contactRegex = /^[\d\s\+\-\(\)]{7,15}$/;
    if (!contactRegex.test(contactNumber)) {
        showStatus('‚ö†Ô∏è Please enter a valid contact number (7-15 digits)', 'error');
        document.getElementById('form-contactNumber').focus();
        document.getElementById('form-contactNumber').style.borderColor = '#fc466b';
        return;
    }

    document.getElementById('form-contactNumber').style.borderColor = '#667eea';

    const selectedAction = 'Consumable Request';

    console.log('='.repeat(50));
    console.log('üîß CONSUMABLE REQUEST SELECTED');
    console.log('='.repeat(50));
    updateDebugPanel(`Submitting ${selectedAction}...`);

    disableActionButtons(true);
    showStatus(`‚è≥ ${selectedAction} selected. Processing...`, 'loading');

    const requestPayload = {
        action: 'consumable_request',
        equipment_id: currentEquipmentId,
        area: area,
        location: equipmentLocation,
        hospital: hospital,
        unit_code: unitCode,
        serial_number: serialNumber,
        supplier_name: supplierName,
        unit: unit,
        item_id: itemId,
        contact_number: contactNumber,
        product_model: productModel,
        product_type: productType,
        modality: modality,
        city: city
    };

    console.log('üì§ Request Payload:', JSON.stringify(requestPayload, null, 2));
    console.log('üì§ Endpoint: /api/CR');
    console.log('='.repeat(50));

    fetch('/api/CR', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'Accept': 'application/json'
        },
        body: JSON.stringify(requestPayload)
    })
    .then(response => {
        console.log('üì• Response Status:', response.status);
        console.log('üì• Response OK:', response.ok);

        return response.json().then(data => {
            data._httpStatus = response.status;
            data._httpOk = response.ok;
            return data;
        }).catch(parseError => {
            console.error('‚ùå JSON Parse Error:', parseError);
            throw new Error(`Server returned invalid JSON (Status: ${response.status})`);
        });
    })
    .then(data => {
        console.log('üì¶ Response Data:', data);
        console.log('='.repeat(50));

        if (data.success) {
            updateDebugPanel(`‚úÖ ${selectedAction} completed!`);
            showStatus(`‚úÖ ${data.message || 'Request submitted successfully!'}`, 'success');
            disableSpecificButton('consumable_request');
        } else {
            const errorMsg = data.error || 'Unknown error occurred';
            console.error('‚ùå API Error:', errorMsg);
            updateDebugPanel(`‚ùå ${selectedAction} failed: ${errorMsg}`);
            showStatus(`‚ùå Failed: ${errorMsg}`, 'error');
        }
    })
    .catch(error => {
        console.error('='.repeat(50));
        console.error('‚ùå Request Failed:', error);
        console.error('Error Message:', error.message);
        console.error('Error Stack:', error.stack);
        console.error('='.repeat(50));

        updateDebugPanel(`‚ùå Error: ${error.message}`);
        showStatus(`‚ùå Failed: ${error.message}`, 'error');
    })
    .finally(() => {
        disableActionButtons(false);
        console.log('üèÅ Request completed');
        console.log('='.repeat(50));
    });
}

// ============================================
// USER TRAINING REQUEST HANDLER
// ============================================
function selectActionUserTraining(action) {
    if (!masterDataLoaded) {
        showStatus('‚ö†Ô∏è Please load master data first', 'error');
        return;
    }

    contactNumber = document.getElementById('form-contactNumber').value.trim();

    if (!contactNumber) {
        showStatus('‚ö†Ô∏è Please enter a contact number', 'error');
        document.getElementById('form-contactNumber').focus();
        document.getElementById('form-contactNumber').style.borderColor = '#fc466b';
        return;
    }

    const contactRegex = /^[\d\s\+\-\(\)]{7,15}$/;
    if (!contactRegex.test(contactNumber)) {
        showStatus('‚ö†Ô∏è Please enter a valid contact number (7-15 digits)', 'error');
        document.getElementById('form-contactNumber').focus();
        document.getElementById('form-contactNumber').style.borderColor = '#fc466b';
        return;
    }

    document.getElementById('form-contactNumber').style.borderColor = '#667eea';

    const selectedAction = 'User Training Request';

    console.log('='.repeat(50));
    console.log('üîß USER TRAINING REQUEST SELECTED');
    console.log('='.repeat(50));
    updateDebugPanel(`Submitting ${selectedAction}...`);

    disableActionButtons(true);
    showStatus(`‚è≥ ${selectedAction} selected. Processing...`, 'loading');

    const requestPayload = {
        action: 'user_training',
        equipment_id: currentEquipmentId,
        area: area,
        location: equipmentLocation,
        hospital: hospital,
        unit_code: unitCode,
        serial_number: serialNumber,
        supplier_name: supplierName,
        unit: unit,
        item_id: itemId,
        contact_number: contactNumber,
        product_model: productModel,
        product_type: productType,
        modality: modality,
        city: city
    };

    console.log('üì§ Request Payload:', JSON.stringify(requestPayload, null, 2));
    console.log('üì§ Endpoint: /api/UserTraining');
    console.log('='.repeat(50));

    fetch('/api/UserTraining', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'Accept': 'application/json'
        },
        body: JSON.stringify(requestPayload)
    })
    .then(response => {
        console.log('üì• Response Status:', response.status);
        console.log('üì• Response OK:', response.ok);

        return response.json().then(data => {
            data._httpStatus = response.status;
            data._httpOk = response.ok;
            return data;
        }).catch(parseError => {
            console.error('‚ùå JSON Parse Error:', parseError);
            throw new Error(`Server returned invalid JSON (Status: ${response.status})`);
        });
    })
    .then(data => {
        console.log('üì¶ Response Data:', data);
        console.log('='.repeat(50));

        if (data.success) {
            updateDebugPanel(`‚úÖ ${selectedAction} completed!`);
            showStatus(`‚úÖ ${data.message || 'Request submitted successfully!'}`, 'success');
            disableSpecificButton('user_training');
        } else {
            const errorMsg = data.error || 'Unknown error occurred';
            console.error('‚ùå API Error:', errorMsg);
            updateDebugPanel(`‚ùå ${selectedAction} failed: ${errorMsg}`);
            showStatus(`‚ùå Failed: ${errorMsg}`, 'error');
        }
    })
    .catch(error => {
        console.error('='.repeat(50));
        console.error('‚ùå Request Failed:', error);
        console.error('Error Message:', error.message);
        console.error('Error Stack:', error.stack);
        console.error('='.repeat(50));

        updateDebugPanel(`‚ùå Error: ${error.message}`);
        showStatus(`‚ùå Failed: ${error.message}`, 'error');
    })
    .finally(() => {
        disableActionButtons(false);
        console.log('üèÅ Request completed');
        console.log('='.repeat(50));
    });
}

// ============================================
// ONE TIME SERVICE REQUEST HANDLER
// ============================================
function selectActionOTS(action) {
    if (!masterDataLoaded) {
        showStatus('‚ö†Ô∏è Please load master data first', 'error');
        return;
    }

    contactNumber = document.getElementById('form-contactNumber').value.trim();

    if (!contactNumber) {
        showStatus('‚ö†Ô∏è Please enter a contact number', 'error');
        document.getElementById('form-contactNumber').focus();
        document.getElementById('form-contactNumber').style.borderColor = '#fc466b';
        return;
    }

    const contactRegex = /^[\d\s\+\-\(\)]{7,15}$/;
    if (!contactRegex.test(contactNumber)) {
        showStatus('‚ö†Ô∏è Please enter a valid contact number (7-15 digits)', 'error');
        document.getElementById('form-contactNumber').focus();
        document.getElementById('form-contactNumber').style.borderColor = '#fc466b';
        return;
    }

    document.getElementById('form-contactNumber').style.borderColor = '#667eea';

    const selectedAction = 'One Time Service Request';

    console.log('='.repeat(50));
    console.log('üîß ONE TIME SERVICE REQUEST SELECTED');
    console.log('='.repeat(50));
    updateDebugPanel(`Submitting ${selectedAction}...`);

    disableActionButtons(true);
    showStatus(`‚è≥ ${selectedAction} selected. Processing...`, 'loading');

    const requestPayload = {
        action: 'one_time_service',
        equipment_id: currentEquipmentId,
        area: area,
        location: equipmentLocation,
        hospital: hospital,
        unit_code: unitCode,
        serial_number: serialNumber,
        supplier_name: supplierName,
        unit: unit,
        item_id: itemId,
        contact_number: contactNumber,
        product_model: productModel,
        product_type: productType,
        modality: modality,
        city: city
    };

    console.log('üì§ Request Payload:', JSON.stringify(requestPayload, null, 2));
    console.log('üì§ Endpoint: /api/OTS');
    console.log('='.repeat(50));

    fetch('/api/OTS', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'Accept': 'application/json'
        },
        body: JSON.stringify(requestPayload)
    })
    .then(response => {
        console.log('üì• Response Status:', response.status);
        console.log('üì• Response OK:', response.ok);

        return response.json().then(data => {
            data._httpStatus = response.status;
            data._httpOk = response.ok;
            return data;
        }).catch(parseError => {
            console.error('‚ùå JSON Parse Error:', parseError);
            throw new Error(`Server returned invalid JSON (Status: ${response.status})`);
        });
    })
    .then(data => {
        console.log('üì¶ Response Data:', data);
        console.log('='.repeat(50));

        if (data.success) {
            updateDebugPanel(`‚úÖ ${selectedAction} completed!`);
            showStatus(`‚úÖ ${data.message || 'Request submitted successfully!'}`, 'success');
            disableSpecificButton('one_time_service');
        } else {
            const errorMsg = data.error || 'Unknown error occurred';
            console.error('‚ùå API Error:', errorMsg);
            updateDebugPanel(`‚ùå ${selectedAction} failed: ${errorMsg}`);
            showStatus(`‚ùå Failed: ${errorMsg}`, 'error');
        }
    })
    .catch(error => {
        console.error('='.repeat(50));
        console.error('‚ùå Request Failed:', error);
        console.error('Error Message:', error.message);
        console.error('Error Stack:', error.stack);
        console.error('='.repeat(50));

        updateDebugPanel(`‚ùå Error: ${error.message}`);
        showStatus(`‚ùå Failed: ${error.message}`, 'error');
    })
    .finally(() => {
        disableActionButtons(false);
        console.log('üèÅ Request completed');
        console.log('='.repeat(50));
    });
}

function disableSpecificButton(action) {
    const actionToButtonId = {
        'repair': 'repairBtn',
        'user_training': 'trainingBtn',
        'one_time_service': 'otsBtn',
        'consumable_request': 'consumableBtn',
        'consumer_request': 'statusBtn'
    };
    
    const buttonId = actionToButtonId[action];
    if (buttonId) {
        const button = document.getElementById(buttonId);
        if (button) {
            button.disabled = true;
            button.style.opacity = '0.6';
            button.style.cursor = 'not-allowed';
            button.innerHTML = `
                <div class="action-icon">‚úÖ</div>
                <div>Completed</div>
            `;
        }
    }
}

function disableActionButtons(disable) {
    const actionBtns = document.querySelectorAll('.action-btn');
    actionBtns.forEach(btn => {
        if (!btn.innerHTML.includes('‚úÖ')) {
            btn.disabled = disable;
            btn.style.cursor = disable ? 'not-allowed' : 'pointer';
            btn.style.opacity = disable ? '0.6' : '1';
        }
    });
}

function goBackToGenerator() {
    window.location.href = '/';
}

function showStatus(message, type) {
    const statusDiv = document.getElementById('statusMessage');
    let iconClass = '';

    if (type === 'loading') {
        iconClass = '<div class="spinner"></div>';
    }

    statusDiv.innerHTML = `<div class="status-message status-${type}">${iconClass}${message}</div>`;

    if (type === 'success') {
        setTimeout(() => {
            statusDiv.innerHTML = '';
        }, 5000);
    } else if (type === 'error') {
        setTimeout(() => {
            statusDiv.innerHTML = '';
        }, 10000);
    }
}
</script>
{% endblock %}