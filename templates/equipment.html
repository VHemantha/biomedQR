{% extends "base.html" %}

{% block title %}Equipment {{ equipment_id }} - Actions{% endblock %}

{% block content %}
<button class="back-btn" onclick="goBackToGenerator()">‚Üê Back to Generator</button>

<div class="equipment-info">
    üè≠ Item: <span style="color: #667eea;">{{ equipment_id }}</span>
</div>

<div class="welcome-section">
    <h2 class="welcome-title">Welcome to Equipment Portal</h2>
    <p class="welcome-subtitle">Get master data to proceed:</p>
</div>

<!-- Scanning Status Indicator -->
<div id="scanningIndicator" class="scanning-indicator" style="display: none; text-align: center; margin: 20px 0; padding: 15px; background-color: #e6fffa; border-left: 4px solid #38b6a8; border-radius: 4px;">
    <div class="spinner" style="display: inline-block; margin-right: 10px;"></div>
    <span id="scanningText" style="color: #38b6a8; font-weight: 500;">Scanning QR/Barcode... Auto-fetching data</span>
</div>

<!-- Waiting for Scan Message -->
<div style="text-align: center; margin: 30px 0; padding: 20px; background-color: #f0f4ff; border-radius: 8px; border: 2px dashed #667eea;">
    <div style="font-size: 18px; color: #667eea; font-weight: 500;">üì± Ready for Scan</div>
    <p style="color: #718096; margin-top: 10px;">Please scan the QR code or barcode to load equipment data</p>
</div>

<!-- Master Data Form Section (Initially Hidden) -->
<div id="masterDataForm" class="master-data-form" style="display: none;">
    <h3 style="color: #667eea; margin-bottom: 20px;">Equipment Details</h3>
    
    <div class="form-group">
        <label for="form-itemID">Item ID:</label>
        <input type="text" id="form-itemID" readonly style="background-color: #f5f5f5;">
    </div>
    
    <div class="form-group">
        <label for="form-productLocation">Hospital / Location:</label>
        <input type="text" id="form-productLocation" readonly style="background-color: #f5f5f5;">
    </div>
    
    <div class="form-group">
        <label for="form-productModel">Product Model:</label>
        <input type="text" id="form-productModel" readonly style="background-color: #f5f5f5;">
    </div>
    
    <div class="form-group">
        <label for="form-serialNumber">Serial Number:</label>
        <input type="text" id="form-serialNumber" readonly style="background-color: #f5f5f5;">
    </div>
    
    <div class="form-group">
        <label for="form-supplierName">Supplier Name:</label>
        <input type="text" id="form-supplierName" readonly style="background-color: #f5f5f5;">
    </div>
    
    <div class="form-group">
        <label for="form-unit">Unit:</label>
        <input type="text" id="form-unit" readonly style="background-color: #f5f5f5;">
    </div>
    
    <div class="form-group">
        <label for="form-createdDate">Created Date:</label>
        <input type="text" id="form-createdDate" readonly style="background-color: #f5f5f5;">
    </div>
    
    <div class="form-group">
        <label for="form-lastUpdatedDate">Last Updated Date:</label>
        <input type="text" id="form-lastUpdatedDate" readonly style="background-color: #f5f5f5;">
    </div>
    
    <!-- Contact Number - Editable Field -->
    <div class="form-group">
        <label for="form-contactNumber">Contact Number: <span style="color: #fc466b;">*</span></label>
        <input type="tel" id="form-contactNumber" placeholder="Enter contact number" required style="background-color: #ffffff; border: 2px solid #667eea;">
        <small style="color: #718096; font-size: 12px;">Required field - Please enter your contact number</small>
    </div>
</div>

<!-- Action Options (Initially Disabled) -->
<div class="action-options" id="actionOptions" style="opacity: 0.5; pointer-events: none;">
    <button class="action-btn repair" onclick="selectAction('repair')" id="repairBtn" disabled>
        <div class="action-icon">üîß</div>
        <div>Repair</div>
    </button>
    
    <button class="action-btn training" onclick="selectAction('user_training')" id="trainingBtn" disabled>
        <div class="action-icon">üìö</div>
        <div>User Training</div>
    </button>
    
    <button class="action-btn maintenance" onclick="selectAction('one_time_service')" id="maintenanceBtn" disabled>
        <div class="action-icon">‚öôÔ∏è</div>
        <div>One time service request</div>
    </button>
    
    <button class="action-btn status" onclick="selectAction('consumer_request')" id="statusBtn" disabled>
        <div class="action-icon">üìä</div>
        <div>Consumer request</div>
    </button>
</div>

<div id="statusMessage"></div>
{% endblock %}

{% block extra_scripts %}
<script>
// Application state
const currentEquipmentId = '{{ equipment_id }}';
let hospital = `{{ hospital }}`;
let unitCode = `{{ unit_code }}`;
let serialNumber = `{{ serial_number }}`;
let supplierName = `{{ supplier_name }}`;
let unit = `{{ unit }}`;
let itemId = `{{ item_id }}`;
let masterDataLoaded = false;
let contactNumber = '';
let autoScannedData = false;
let scanBuffer = '';
let scanTimeout = null;
const SCAN_TIMEOUT = 100; // milliseconds to wait for scan completion

// Initialize auto-scan detection on page load
document.addEventListener('DOMContentLoaded', function() {
    initializeScanDetection();
});

// Initialize barcode/QR scan detection
function initializeScanDetection() {
    let scanBuffer = '';
    let isScanning = false;

    // Listen for keyboard input (barcode scanners typically emit keyboard events)
    document.addEventListener('keydown', function(event) {
        // Start scan detection
        if (!isScanning) {
            isScanning = true;
            showScanningIndicator(true);
        }

        // Clear existing timeout
        if (scanTimeout) {
            clearTimeout(scanTimeout);
        }

        // Accumulate characters
        if (event.key !== 'Enter') {
            scanBuffer += event.key;
        }

        // Detect scan completion (Enter key marks end of scan)
        if (event.key === 'Enter' && scanBuffer.length > 0) {
            event.preventDefault();
            handleScanComplete(scanBuffer);
            scanBuffer = '';
            isScanning = false;
            showScanningIndicator(false);
            return;
        }

        // Set timeout to detect scan end if no Enter key
        scanTimeout = setTimeout(() => {
            if (scanBuffer.length > 3) { // Minimum scan length
                handleScanComplete(scanBuffer);
                scanBuffer = '';
            }
            isScanning = false;
            showScanningIndicator(false);
        }, SCAN_TIMEOUT);
    });
}

// Show/hide scanning indicator
function showScanningIndicator(show) {
    const indicator = document.getElementById('scanningIndicator');
    if (show) {
        indicator.style.display = 'block';
    } else {
        setTimeout(() => {
            indicator.style.display = 'none';
        }, 500);
    }
}

// Handle scan completion
function handleScanComplete(scannedData) {
    console.log('Scan detected:', scannedData);
    
    // Optionally: parse scanned data if it contains equipment ID
    // Example: If QR code contains equipment ID format like "EQ12345"
    const equipmentIdMatch = scannedData.match(/([A-Z]{2}\d+)/);
    
    if (equipmentIdMatch || scannedData.length > 3) {
        autoScannedData = true;
        // Automatically fetch master data
        fetchAndMapMasterData();
    }
}

// Fetch master data from API
function fetchAndMapMasterData() {
    const btn = document.getElementById('getMasterDataBtn');
    const formSection = document.getElementById('masterDataForm');
    const actionOptions = document.getElementById('actionOptions');

    // Disable button while loading
    btn.disabled = true;
    btn.innerHTML = '<div class="spinner"></div><div>Loading...</div>';

    const source = autoScannedData ? 'auto-scan' : 'manual';
    showStatus(`Fetching master data from API (${source})...`, 'loading');

    // Fetch master data from backend
    fetch(`/api/get_master_data/${itemId}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Map the fetched data to form fields
                document.getElementById('form-itemID').value = data.data.itemID || 'N/A';
                document.getElementById('form-productLocation').value = data.data.productLocation || 'N/A';
                document.getElementById('form-productModel').value = data.data.productModel || 'N/A';
                document.getElementById('form-serialNumber').value = data.data.serialNumber || 'N/A';
                document.getElementById('form-supplierName').value = data.data.supplierName || 'N/A';
                document.getElementById('form-unit').value = data.data.unit || 'N/A';
                document.getElementById('form-createdDate').value = data.data.createdDate || 'N/A';
                document.getElementById('form-lastUpdatedDate').value = data.data.lastUpdatedDate || 'N/A';
                
                // Contact Number from API (if exists)
                if (data.data.contactNumber) {
                    document.getElementById('form-contactNumber').value = data.data.contactNumber;
                }

                // Update local variables with fetched data
                hospital = data.data.productLocation || hospital;
                unitCode = data.data.productModel || unitCode;
                serialNumber = data.data.serialNumber || serialNumber;
                supplierName = data.data.supplierName || supplierName;
                unit = data.data.unit || unit;

                // Show the form section
                formSection.style.display = 'block';

                // Enable action buttons
                enableActionButtons();
                masterDataLoaded = true;

                const message = autoScannedData 
                    ? 'Master data auto-loaded from scan! Please enter contact number and select an action.'
                    : 'Master data loaded successfully! Please enter contact number and select an action.';
                showStatus(message, 'success');
            } else {
                showStatus(`Error: ${data.error}`, 'error');
            }
        })
        .catch(error => {
            console.error('Fetch error:', error);
            showStatus(`Failed to fetch master data: ${error.message}`, 'error');
        });
}

function enableActionButtons() {
    const actionOptions = document.getElementById('actionOptions');
    const actionBtns = document.querySelectorAll('.action-btn');
    
    // Enable the action section
    actionOptions.style.opacity = '1';
    actionOptions.style.pointerEvents = 'auto';
    
    // Enable all action buttons
    actionBtns.forEach(btn => {
        btn.disabled = false;
        btn.style.cursor = 'pointer';
    });
}

function selectAction(action) {
    if (!masterDataLoaded) {
        showStatus('Please load master data first by clicking "Get Master Data" button', 'error');
        return;
    }

    // Get contact number from the input field
    contactNumber = document.getElementById('form-contactNumber').value.trim();
    
    // Validate contact number
    if (!contactNumber) {
        showStatus('Please enter a contact number before submitting a request', 'error');
        document.getElementById('form-contactNumber').focus();
        document.getElementById('form-contactNumber').style.borderColor = '#fc466b';
        return;
    }

    // Reset border color
    document.getElementById('form-contactNumber').style.borderColor = '#667eea';

    const actionNames = {
        'repair': 'Repair',
        'user_training': 'User Training',
        'one_time_service': 'One Time Service',
        'consumer_request': 'Consumer Request'
    };
    
    const selectedAction = actionNames[action];
    
    // Disable all action buttons while processing
    disableActionButtons(true);
    
    showStatus(`${selectedAction} selected for equipment ${itemId}. Processing...`, 'loading');
    
    // Make API request to Flask backend
    fetch('/api/action', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            action: action,
            equipment_id: currentEquipmentId,
            hospital: hospital,
            unit_code: unitCode,
            serial_number: serialNumber,
            supplier_name: supplierName,
            unit: unit,
            item_id: itemId,
            contact_number: contactNumber
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showStatus(data.message, 'success');
            // Disable the specific button that was clicked
            disableSpecificButton(action);
        } else {
            showStatus(`Failed: ${data.error}`, 'error');
        }
    })
    .catch(error => {
        console.error('Action error:', error);
        showStatus(`Failed to submit ${selectedAction.toLowerCase()} request: ${error.message}`, 'error');
    })
    .finally(() => {
        disableActionButtons(false);
    });
}

function disableSpecificButton(action) {
    // Map action to button ID
    const actionToButtonId = {
        'repair': 'repairBtn',
        'user_training': 'trainingBtn',
        'one_time_service': 'maintenanceBtn',
        'consumer_request': 'statusBtn'
    };
    
    const buttonId = actionToButtonId[action];
    if (buttonId) {
        const button = document.getElementById(buttonId);
        if (button) {
            button.disabled = true;
            button.style.opacity = '0.6';
            button.style.cursor = 'not-allowed';
            button.innerHTML = `
                <div class="action-icon">‚úÖ</div>
                <div>Completed</div>
            `;
        }
    }
}

function disableActionButtons(disable) {
    const actionBtns = document.querySelectorAll('.action-btn');
    actionBtns.forEach(btn => {
        if (!btn.innerHTML.includes('‚úÖ')) { // Don't re-enable completed buttons
            btn.disabled = disable;
            if (disable) {
                btn.style.cursor = 'not-allowed';
                btn.style.opacity = '0.6';
            } else {
                btn.style.cursor = 'pointer';
                btn.style.opacity = '1';
            }
        }
    });
}

function goBackToGenerator() {
    window.location.href = '/';
}

function showStatus(message, type) {
    const statusDiv = document.getElementById('statusMessage');
    let iconClass = '';

    if (type === 'loading') {
        iconClass = '<div class="spinner"></div>';
    }

    statusDiv.innerHTML = `<div class="status-message status-${type}">${iconClass}${message}</div>`;

    if (type === 'success') {
        setTimeout(() => {
            statusDiv.innerHTML = '';
        }, 5000);
    } else if (type === 'error') {
        setTimeout(() => {
            statusDiv.innerHTML = '';
        }, 10000);
    }
}
</script>
{% endblock %}